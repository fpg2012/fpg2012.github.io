<!DOCTYPE html>

<html>
    <head>
        
        <title>Empty Space - OpenGLåŠ è½½glTFæ¨¡å‹</title>
        
        <meta charset="UTF-8">
        <meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport">

        
        <meta name="description" content="æœ€è¿‘ä¸€æ—¶å…´èµ·ï¼Œå†³å®šå¤ä¹ ä¸€ä¸‹OpenGLã€‚æ‰“ç®—ç”¨ä¸€å‘¨çš„æ—¶é—´â€œé€Ÿé€šâ€ä¸€ä¸‹OpenGLï¼ˆæŒ‡ç”»ä¸‰è§’å½¢ã€å®ç°MVPå˜æ¢ã€å®ç°PCSSè½¯é˜´å½±åˆ°åˆ°åŠ è½½glTFæ¨¡å‹ï¼‰ã€‚ä¹‹å‰è¿‡ä¸€éVulkan Tutorialçš„æ—¶å€™ï¼Œä¸€ç›´æƒ³æŠŠsketchfabä¸Šé¢çš„æ¨¡å‹åŠ è½½è¿›æ¥ï¼Œå¯æƒœå½“æ—¶æä¸æ˜ç™½GLTFçš„æ ¼å¼ï¼Œç½‘ä¸Šç°æˆçš„èµ„æ–™ä¹Ÿä¸æ˜¯å¤ªå¤šã€‚è¿™æ¬¡ä¸€å‘¨å¿«é€Ÿå¤ä¹ OpenGLå¯¹æˆ‘æ¥è¯´è¿˜æ˜¯æœ‰ç‚¹æŒ‘æˆ˜ã€‚å¥½åœ¨æˆ‘ç¡®å®ä¸€å‘¨å†…æå‡ºæ¥äº†ã€‚">
        

        
        <meta name="keywords" content="OpenGL,glTF,CG,è®¡ç®—æœºå›¾å½¢å­¦,3d">
        

        <link rel="stylesheet" href="//nth233.top/assets/style/main.css">
        <link rel="stylesheet" href="//nth233.top/assets/style/tango.css">
        <link rel="stylesheet" href="//nth233.top/assets/style/katex.min.css" integrity="sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ" crossorigin="anonymous">

        
        
        <link rel="apple-touch-icon" sizes="180x180" href="//nth233.top/assets/favicon/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="//nth233.top/assets/favicon/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="//nth233.top/assets/favicon/favicon-16x16.png">
        <link rel="manifest" href="//nth233.top/assets/favicon/site.webmanifest">
        
    </head>
    <body>
        <header>

<div class="header-logo">
    <img class="nth233logo" src="//nth233.top/assets/img/404.png"></img>
    <a href="//nth233.top/">Empty Space</a>
</div>

<div class="header-menu">
    <div id="search-button" class="search-control search-button">
        <svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 512 512"><!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6 .1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
    </div>
    <a href="//nth233.top/notes/">Notes</a>
    <a href="//nth233.top/about/">About</a>
    <a href="//nth233.top/feed.xml">RSS</a>
    <!--<a href="//nth233.top/friends.html">Friends</a>-->
    <div id="theme-switch" class="header-button" title="å¤œå¹•é™ä¸´">ğŸŒ’</div>
</div>
</header>
<div id="search-area" class="search-area hide">
    <input id="search-box" class="search-box" type="text">
    <div id="search-result-area">
    
    </div>
</div>
        <script src="//nth233.top/assets/js/switch-theme.js"></script>
        <main>
            
<div class='post-menu'>
    <div class='menu-title'>OpenGLåŠ è½½glTFæ¨¡å‹</div>
    <hr>
</div> 
<div class="post-area">
<div class="post-front-matter">
    
    <h1>OpenGLåŠ è½½glTFæ¨¡å‹</h1>
    
    <div class="date-bar">
        <span class="date">2024-03-14</span>
    </div>
    <div class="category-bar">
    
        <span class="category">ã€”devã€•</span>
    
    </div>
    <div class="tag-bar">
    
        <span class="tag">#OpenGL</span>
    
        <span class="tag">#glTF</span>
    
        <span class="tag">#CG</span>
    
        <span class="tag">#è®¡ç®—æœºå›¾å½¢å­¦</span>
    
        <span class="tag">#3d</span>
    
    </div>
</div>
<hr class="hr-wavy">
<div class="post-content">
    <p>æœ€è¿‘ä¸€æ—¶å…´èµ·ï¼Œå†³å®šå¤ä¹ ä¸€ä¸‹OpenGLã€‚æ‰“ç®—ç”¨ä¸€å‘¨çš„æ—¶é—´â€œé€Ÿé€šâ€ä¸€ä¸‹OpenGLï¼ˆæŒ‡ç”»ä¸‰è§’å½¢ã€å®ç°MVPå˜æ¢ã€å®ç°PCSSè½¯é˜´å½±åˆ°åˆ°åŠ è½½glTFæ¨¡å‹ï¼‰ã€‚ä¹‹å‰è¿‡ä¸€éVulkan
Tutorialçš„æ—¶å€™ï¼Œä¸€ç›´æƒ³æŠŠsketchfabä¸Šé¢çš„æ¨¡å‹åŠ è½½è¿›æ¥ï¼Œå¯æƒœå½“æ—¶æä¸æ˜ç™½glTFçš„æ ¼å¼ï¼Œç½‘ä¸Šç°æˆçš„èµ„æ–™ä¹Ÿä¸æ˜¯å¤ªå¤šã€‚</p>
<p>è¿™æ¬¡ä¸€å‘¨å¿«é€Ÿå¤ä¹ OpenGLå¯¹æˆ‘æ¥è¯´è¿˜æ˜¯æœ‰ç‚¹æŒ‘æˆ˜ã€‚å¥½åœ¨æˆ‘ç¡®å®ä¸€å‘¨å†…æå‡ºæ¥çš„ï¼Œä¸­é—´å¡å…³äº†å‡ æ¬¡éƒ½æ˜¯å› ä¸ºæŸäº›æ™ºéšœé”™è¯¯ã€‚</p>
<p>æœ¬æ–‡ä¸»è¦å…³æ³¨åŠ è½½åŸºæœ¬çš„glTFæ¨¡å‹ï¼Œä¸ä¼šæ¶‰åŠé˜´å½±ã€‚æœ€ç»ˆæ•ˆæœå¦‚ä¸‹ã€‚</p>
<figure>
<img src="attachment/ae4920e639fad546be98cfdc9e775ddf.png"
alt="æœ€ç»ˆæ•ˆæœ" />
<figcaption aria-hidden="true">æœ€ç»ˆæ•ˆæœ</figcaption>
</figure>
<h2 id="å‰ç½®çŸ¥è¯†">å‰ç½®çŸ¥è¯†</h2>
<h3 id="openglåŸºç¡€çŸ¥è¯†">OpenGLåŸºç¡€çŸ¥è¯†</h3>
<p>å¦‚æœå·²ç»ç†Ÿæ‚‰OpenGLï¼Œè¯·ç›´æ¥è·³åˆ°GLTFæ–‡ä»¶æ ¼å¼ä¸€èŠ‚ã€‚ä¸€ä¸‹å†…å®¹å»ºè®®ç»“åˆLearnOpenGLé˜…è¯»ã€‚</p>
<h4 id="æ¦‚è¿°">æ¦‚è¿°</h4>
<p>åŠ è½½3Dæ¨¡å‹ï¼Œå½’æ ¹åˆ°åº•å°±æ˜¯åœ¨ç»˜åˆ¶ä¸€ç³»åˆ—ä¸‰è§’å½¢ã€‚ç»™å®šæ¯ä¸€ä¸ªä¸‰è§’å½¢é¡¶ç‚¹çš„ä½ç½®ã€é¡¶ç‚¹å¯¹åº”çš„çº¹ç†åæ ‡ã€é¡¶ç‚¹å¯¹åº”çš„æ³•å‘é‡ï¼Œå‰©ä¸‹çš„å°±äº¤ç»™OpenGLå’ŒGPUçš„æ¸²æŸ“ç®¡çº¿ã€‚ç®¡çº¿çš„ä¸€ç«¯æ˜¯æˆ‘ä»¬ä¼ è¿›å»çš„é¡¶ç‚¹ä¿¡æ¯ï¼Œå¦ä¸€ç«¯å‡ºæ¥çš„å°±æ˜¯ç»˜åˆ¶çš„ç»“æœã€‚</p>
<figure>
<img src="attachment/f1804831514d1e4e78e75bf8af84f9ef.png"
alt="OpenGLçš„æ¸²æŸ“ç®¡çº¿" />
<figcaption aria-hidden="true">OpenGLçš„æ¸²æŸ“ç®¡çº¿</figcaption>
</figure>
<p><a
href="https://www.khronos.org/opengl/wiki/Rendering_Pipeline_Overview">OpenGLçš„æ¸²æŸ“ç®¡çº¿</a>ç¯èŠ‚æœ‰å¾ˆå¤šï¼ˆå›¾æ¥è‡ª<a
href="https://www.khronos.org/opengl/wiki/Rendering_Pipeline_Overview">Khronosçš„wiki</a>ï¼‰ã€‚ä¸è¿‡ç®€å•èµ·è§ï¼Œæˆ‘ä»¬è®¤ä¸ºè¾“å…¥é¡¶ç‚¹çš„æ•°æ®ç»è¿‡ç®€å•å¤„ç†ï¼Œä¼šä¼ é€’ç»™é¡¶ç‚¹ç€è‰²å™¨â²Vertex
Shaderâ³ã€‚é¡¶ç‚¹ç€è‰²å™¨çš„è¾“å‡ºåœ¨å…‰æ …åŒ–åï¼Œåˆä¼ ç»™ç‰‡å…ƒç€è‰²å™¨â²Fragment
Shaderâ³ï¼Œæœ€åç»è¿‡æ¨¡æ¿æµ‹è¯•ã€æ·±åº¦æµ‹è¯•å’Œæ··åˆï¼Œå†™å…¥å¸§ç¼“å†²â²Framebufferâ³ã€‚æ¸²æŸ“çš„ç»“æœä¼šé€šè¿‡äº¤æ¢é“¾â²Swapchainâ³è¢«äº¤æ¢åˆ°å±å¹•ä¸Šæ˜¾ç¤ºå‡ºæ¥ã€‚</p>
<p>åœ¨æ¸²æŸ“ç®¡çº¿å¼€å§‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æŠŠæ•°æ®ä»å†…å­˜ä¼ é€’åˆ°GPUã€‚è¿™éƒ¨åˆ†éœ€è¦åœ¨æ˜¾å­˜åˆ›å»ºç¼“å†²åŒºï¼Œå¹¶å¾€é‡Œé¢å¡«ä¸Šæ•°æ®ã€‚è¿˜éœ€è¦å¯¹æ•°æ®çš„æ ¼å¼ï¼ˆé•¿åº¦ã€ç±»å‹ã€æ­¥é•¿ç­‰ç­‰ï¼‰è¿›è¡Œè§£é‡Šã€‚</p>
<p>åœ¨é¡¶ç‚¹ç€è‰²å™¨çš„é˜¶æ®µï¼ŒGPUä¼šå¯¹æ¯ä¸ªé¡¶ç‚¹è°ƒç”¨ä¸€æ¬¡é¡¶ç‚¹ç€è‰²å™¨çš„ç¨‹åºã€‚ç»è¿‡å·®å€¼å’Œå…‰æ …åŒ–ä¹‹åï¼Œåœ¨ç‰‡å…ƒç€è‰²å™¨çš„é˜¶æ®µï¼ŒGPUä¼šå¯¹æ¯ä¸€ä¸ªç‰‡å…ƒâ²Fragmentâ³ï¼ˆå¯ä»¥ç†è§£ä¸ºåƒç´ ï¼‰è°ƒç”¨ä¸€æ¬¡ç‰‡å…ƒç€è‰²å™¨ã€‚è¿™ä¸¤ä¸ªç€è‰²å™¨éƒ½éœ€è¦æˆ‘ä»¬è‡ªå·±ç¼–å†™ã€‚ç€è‰²ç¨‹åºæ¶‰åŠçš„ä¸€äº›ç»Ÿä¸€çš„å‚æ•°ï¼ˆæ¯”å¦‚å˜æ¢çŸ©é˜µã€å…‰æºä½ç½®ç­‰ç­‰ï¼‰éœ€è¦é€šè¿‡<code>uniform</code>å˜é‡æ¥ä¼ é€’ã€‚</p>
<p>æ‰€æœ‰ä¸œè¥¿éƒ½å‡†å¤‡å¥½åï¼Œè°ƒç”¨ä¸€æ¬¡ç”»å›¾å‡½æ•°ï¼ˆ<code>glDrawElements</code>ç­‰ï¼‰å°±èƒ½å°†æ‰€éœ€çš„ä¸‰è§’å½¢ç»˜åˆ¶å‡ºæ¥ã€‚æˆ‘ä»¬ç»å¸¸ç”¨ä¸€ä¸ªdraw
callç»˜åˆ¶å¤§é‡çš„ä¸‰è§’å½¢ï¼Œä»¥æé«˜æ•ˆç‡ã€‚</p>
<p>å½“ç„¶ï¼Œè¿™ä¸€åˆ‡å¼€å§‹ä¹‹å‰ï¼Œè¿˜è¦åˆ›å»ºä¸€ä¸ªçª—å£ï¼Œå¹¶ä¸”åˆå§‹åŒ–OpenGLä¸Šä¸‹æ–‡ï¼Œè¿™éƒ¨åˆ†ç”±GLFWä»£åŠ³ã€‚</p>
<h4 id="ç¼“å†²">ç¼“å†²</h4>
<p>è¿™é‡Œæœ‰å¿…è¦å±•å¼€è¯´ä¸€ä¸‹ç¼“å†²ã€‚ç¼“å†²å¯ä»¥å¤§è‡´åˆ†æˆä¸¤ç§ï¼Œä¸€ç§å­˜å‚¨é¡¶ç‚¹çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯å‰é¢æåˆ°çš„ä½ç½®ã€çº¹ç†åæ ‡ã€æ³•å‘é‡ç­‰ç­‰ï¼Œç§°ä¸ºé¡¶ç‚¹ç¼“å†²â²Vertex
Bufferâ³ã€‚å¦ä¸€ç§åˆ™æ˜¯å­˜é¡¶ç‚¹çš„ç´¢å¼•ï¼Œç§°ä¸ºç´¢å¼•ç¼“å†²â²Index
Bufferâ³ã€‚å¼•å…¥é¡¶ç‚¹ç´¢å¼•ç›®çš„ä¸»è¦æ˜¯ä¸ºäº†çœç©ºé—´ã€‚è€ƒè™‘åˆ°å¤æ‚çš„æ¨¡å‹å¯èƒ½æœ‰ä¸å°‘é¡¶ç‚¹åŒæ—¶è¢«ç”¨äºå¤šä¸ªä¸‰è§’å½¢ï¼Œå¦‚æœç”»å›¾çš„æ—¶å€™æ¯ç”»ä¸€ä¸ªä¸‰è§’å½¢ï¼Œå°±è¦ç»™å‡ºé¡¶ç‚¹çš„å…¨éƒ¨æ•°æ®ï¼Œè¿™äº›é‡å¤é¡¶ç‚¹çš„æ•°æ®å°±ä¼šåœ¨æ¶‰åŠçš„æ¯ä¸ªä¸‰è§’å½¢é‡Œé‡å¤ä¸€æ¬¡ï¼Œååˆ†æµªè´¹ç©ºé—´ã€‚ä½¿ç”¨é¡¶ç‚¹ç´¢å¼•åï¼Œç»˜åˆ¶ä¸‰è§’å½¢ä¸å†éœ€è¦ä¸‰ä¸ªé¡¶ç‚¹çš„å…¨éƒ¨æ•°æ®ï¼Œè€Œåªéœ€è¦ç»™å‡ºä¸‰ä¸ªé¡¶ç‚¹çš„ç´¢å¼•ï¼ŒGPUæ ¹æ®è¿™äº›ç´¢å¼•å»é¡¶ç‚¹æ•°æ®é‡Œé¢æŸ¥ç›¸åº”é¡¶ç‚¹çš„æ•°æ®ï¼Œè¿™æ ·å°±èƒ½èŠ‚çº¦å¾ˆå¤šç©ºé—´ã€‚</p>
<p>æ¯æ¬¡è°ƒç”¨ç”»å›¾å‡½æ•°ï¼ŒOpenGLéƒ½éœ€è¦çŸ¥é“å½“å‰çš„é¡¶ç‚¹ç¼“å†²ï¼Œä»¥åŠé¡¶ç‚¹ç¼“å†²å†…æ•°æ®çš„å­˜å‚¨æ ¼å¼ã€‚OpenGLæŠŠè¿™äº›ä¿¡æ¯æ‰“åŒ…èµ·æ¥ï¼Œå’Œé¡¶ç‚¹æ•°ç»„å¯¹è±¡â²Vertex
Array
Objectï¼Œç®€ç§°VAOâ³å…³è”èµ·æ¥ã€‚æ¯æ¬¡ç”»å›¾æ—¶ï¼Œæˆ‘ä»¬åªè¦ç»‘å®šåˆ›å»ºå¥½çš„VAOï¼ˆå¦‚æœè¦ä½¿ç”¨ç´¢å¼•ï¼Œè¿˜è¦ç»‘å®šç´¢å¼•ç¼“å†²å¯¹è±¡ï¼‰ï¼Œè°ƒç”¨draw
callå³å¯ã€‚</p>
<p>é‚£ä¹ˆå¦‚ä½•æŠŠé¡¶ç‚¹ç¼“å†²çš„ç»“æ„å’ŒVAOå…³è”èµ·æ¥å‘¢ï¼Ÿæˆ‘ä»¬åªéœ€è¦åœ¨åˆ›å»ºå¯¹åº”çš„VAOä¹‹åï¼Œç»‘å®šå¯¹åº”å±æ€§ï¼ˆæ¯”å¦‚é¡¶ç‚¹ä½ç½®ï¼‰æ‰€åœ¨çš„é¡¶ç‚¹ç¼“å†²ï¼Œç„¶åè°ƒç”¨<code>glVertexAttribPointer</code>ï¼Œå‘ŠçŸ¥ç±»å‹ã€é•¿åº¦ã€æ­¥é•¿ã€åç§»ç­‰ä¿¡æ¯ï¼ˆå›¾æ¥è‡ª<a
href="https://learnopengl.com/Getting-started/Hello-Triangle">LearnOpenGL</a>ï¼‰ã€‚</p>
<figure>
<img src="attachment/de1bf760da111d0b95a7410c9097e36b.png"
alt="vao &amp; vbo &amp; ebo" />
<figcaption aria-hidden="true">vao &amp; vbo &amp; ebo</figcaption>
</figure>
<h3 id="gltfæ–‡ä»¶æ ¼å¼">glTFæ–‡ä»¶æ ¼å¼</h3>
<blockquote>
<p>glTFâ„¢ is a royalty-free specification for the efficient transmission
and loading of 3D scenes and models by engines and applications. glTF
minimizes the size of 3D assets, and the runtime processing needed to
unpack and use them.</p>
</blockquote>
<p>æœ¬èŠ‚å»ºè®®å‚è€ƒ<a
href="https://registry.khronos.org/glTF/specs/2.0/glTF-2.0.html">glTF
spec</a>ã€‚</p>
<h4 id="åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</h4>
<p>glTFæ˜¯Khronosæå‡ºçš„ä¸€ç§3Då†…å®¹æ ¼å¼ï¼Œå¯ä»¥æ”¯æŒ3Dæ¨¡å‹ã€3DåŠ¨ç”»ï¼Œä¸è¿‡æœ¬æ–‡ä¸ä¼šæ¶‰åŠå’ŒåŠ¨ç”»æœ‰å…³çš„å†…å®¹ï¼Œä¹Ÿä¸ä¼šæ¶‰åŠPBRæè´¨ã€‚SketchFabä¸Šçš„æ¨¡å‹éƒ½æä¾›<code>.glb</code>æˆ–<code>.gltf</code>æ ¼å¼ä¸‹è½½ã€‚</p>
<p>glTFæ ¼å¼æ˜¯åŸºäºJSONçš„ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œè¯·ä»”ç»†æµè§ˆä¸€éã€‚</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;scene&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;scenes&quot;</span><span class="p">:[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Scene&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;nodes&quot;</span><span class="p">:[</span>
<span class="w">                </span><span class="mi">0</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;nodes&quot;</span><span class="p">:[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;mesh&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Cube&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;rotation&quot;</span><span class="p">:[</span>
<span class="w">                </span><span class="mf">-0.5065690875053406</span><span class="p">,</span>
<span class="w">                </span><span class="mf">-0.4970885217189789</span><span class="p">,</span>
<span class="w">                </span><span class="mf">0.49341458082199097</span><span class="p">,</span>
<span class="w">                </span><span class="mf">0.5028250217437744</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;materials&quot;</span><span class="p">:[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;doubleSided&quot;</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Material.001&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;pbrMetallicRoughness&quot;</span><span class="p">:{</span>
<span class="w">                </span><span class="nt">&quot;baseColorTexture&quot;</span><span class="p">:{</span>
<span class="w">                    </span><span class="nt">&quot;index&quot;</span><span class="p">:</span><span class="mi">0</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">                </span><span class="nt">&quot;metallicFactor&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;roughnessFactor&quot;</span><span class="p">:</span><span class="mf">0.5</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;meshes&quot;</span><span class="p">:[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Cube&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;primitives&quot;</span><span class="p">:[</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;attributes&quot;</span><span class="p">:{</span>
<span class="w">                        </span><span class="nt">&quot;POSITION&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
<span class="w">                        </span><span class="nt">&quot;NORMAL&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
<span class="w">                        </span><span class="nt">&quot;TEXCOORD_0&quot;</span><span class="p">:</span><span class="mi">2</span>
<span class="w">                    </span><span class="p">},</span>
<span class="w">                    </span><span class="nt">&quot;indices&quot;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span>
<span class="w">                    </span><span class="nt">&quot;material&quot;</span><span class="p">:</span><span class="mi">0</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;textures&quot;</span><span class="p">:[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;sampler&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;source&quot;</span><span class="p">:</span><span class="mi">0</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;images&quot;</span><span class="p">:[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;mimeType&quot;</span><span class="p">:</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;avatar&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="s2">&quot;avatar.jpg&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;accessors&quot;</span><span class="p">:[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;bufferView&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;componentType&quot;</span><span class="p">:</span><span class="mi">5126</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;count&quot;</span><span class="p">:</span><span class="mi">24</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;max&quot;</span><span class="p">:[</span>
<span class="w">                </span><span class="mi">1</span><span class="p">,</span>
<span class="w">                </span><span class="mi">1</span><span class="p">,</span>
<span class="w">                </span><span class="mi">1</span>
<span class="w">            </span><span class="p">],</span>
<span class="w">            </span><span class="nt">&quot;min&quot;</span><span class="p">:[</span>
<span class="w">                </span><span class="mi">-1</span><span class="p">,</span>
<span class="w">                </span><span class="mi">-1</span><span class="p">,</span>
<span class="w">                </span><span class="mi">-1</span>
<span class="w">            </span><span class="p">],</span>
<span class="w">            </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;VEC3&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;bufferView&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;componentType&quot;</span><span class="p">:</span><span class="mi">5126</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;count&quot;</span><span class="p">:</span><span class="mi">24</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;VEC3&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;bufferView&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;componentType&quot;</span><span class="p">:</span><span class="mi">5126</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;count&quot;</span><span class="p">:</span><span class="mi">24</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;VEC2&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;bufferView&quot;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;componentType&quot;</span><span class="p">:</span><span class="mi">5123</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;count&quot;</span><span class="p">:</span><span class="mi">36</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;SCALAR&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;bufferViews&quot;</span><span class="p">:[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;buffer&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;byteLength&quot;</span><span class="p">:</span><span class="mi">288</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;byteOffset&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;target&quot;</span><span class="p">:</span><span class="mi">34962</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;buffer&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;byteLength&quot;</span><span class="p">:</span><span class="mi">288</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;byteOffset&quot;</span><span class="p">:</span><span class="mi">288</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;target&quot;</span><span class="p">:</span><span class="mi">34962</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;buffer&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;byteLength&quot;</span><span class="p">:</span><span class="mi">192</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;byteOffset&quot;</span><span class="p">:</span><span class="mi">576</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;target&quot;</span><span class="p">:</span><span class="mi">34962</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;buffer&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;byteLength&quot;</span><span class="p">:</span><span class="mi">72</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;byteOffset&quot;</span><span class="p">:</span><span class="mi">768</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;target&quot;</span><span class="p">:</span><span class="mi">34963</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;samplers&quot;</span><span class="p">:[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;magFilter&quot;</span><span class="p">:</span><span class="mi">9729</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;minFilter&quot;</span><span class="p">:</span><span class="mi">9987</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;buffers&quot;</span><span class="p">:[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;byteLength&quot;</span><span class="p">:</span><span class="mi">840</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="s2">&quot;simple_cube.bin&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>

<blockquote>
<p>å…¶å®è¿™æ˜¯æˆ‘ç”¨blenderéšä¾¿ç”»çš„ä¸€ä¸ªæ­£æ–¹ä½“</p>
<figure>
<img src="attachment/4e254885fdff71f701e29a9074979e9e.png"
alt="æ­£æ–¹ä½“" />
<figcaption aria-hidden="true">æ­£æ–¹ä½“</figcaption>
</figure>
</blockquote>
<p>è™½ç„¶å†…å®¹æœ‰ç‚¹å¤šï¼Œä½†ç®€å•æµè§ˆä¹‹åæˆ‘ä»¬ä¼šå‘ç°å…¶å®glTFå°±æ˜¯æŠŠå‡ ä¸ªJSONæ•°ç»„æ”¾åˆ°äº†ä¸€ä¸ªJSONå¯¹è±¡é‡Œé¢å»ï¼Œä¸»è¦åŒ…æ‹¬ï¼š</p>
<ol type="1">
<li>Scene åœºæ™¯</li>
<li>Node ç»“ç‚¹</li>
<li>Texture çº¹ç†</li>
<li>Material æè´¨</li>
<li>Mesh ç½‘æ ¼</li>
<li>Primitive ï¼ˆä¸çŸ¥é“æ€ä¹ˆç¿»è¯‘ï¼Œå§‘ä¸”å«åšâ€œå…ƒä»¶â€ï¼‰</li>
<li>Accessor ï¼ˆä¸çŸ¥é“æ€ä¹ˆç¿»è¯‘ï¼Œå§‘ä¸”å«åšâ€œè®¿é—®å™¨â€ï¼‰</li>
<li>Sampler é‡‡æ ·å™¨</li>
<li>Buffer ç¼“å†²</li>
<li>BufferView ï¼ˆä¸çŸ¥é“æ€ä¹ˆç¿»è¯‘ï¼Œå§‘ä¸”å«åšâ€œç¼“å†²è§†å›¾â€ï¼‰</li>
<li>Image å›¾åƒ</li>
</ol>
<p>å®ƒä»¬ä¹‹é—´çš„å±‚çº§å…³ç³»å¦‚å›¾ï¼ˆå›¾æ¥è‡ª<a
href="https://github.khronos.org/glTF-Tutorials/gltfTutorial/gltfTutorial_002_BasicGltfStructure.html">gltf
tutorial</a>ï¼‰ã€‚</p>
<figure>
<img src="attachment/ccdb395db95a516e3d9c20da25a8336b.png"
alt="å±‚çº§å…³ç³»" />
<figcaption aria-hidden="true">å±‚çº§å…³ç³»</figcaption>
</figure>
<p>ä¸€ä¸ªglTFæ–‡ä»¶åŒ…æ‹¬ä¸€ä¸ªæˆ–å¤šä¸ªSceneï¼Œå…¶ä¸­å¿…å®šæœ‰ä¸€ä¸ªæ˜¯é»˜è®¤åœºæ™¯ï¼Œç”¨<code>scene</code>æŒ‡å®šã€‚æ¯ä¸ªåœºæ™¯å°±æ˜¯ä¸€æ£µNodeæ„æˆçš„æ ‘ï¼Œå› æ­¤è‚¯å®šæœ‰ä¸€ä¸ªæ ¹ç»“ç‚¹ã€‚æœ‰äº›Nodeå«æœ‰Meshï¼Œæ¯ä¸ªMeshå¯èƒ½æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªPrimitiveï¼ŒPrimitiveå…¶å®å°±æ˜¯ä¸€å †ä¸‰è§’å½¢+æè´¨ã€‚æ¯ä¸ªNodeæœ‰è‡ªå·±å¯¹åº”çš„å˜æ¢çŸ©é˜µï¼Œä¹Ÿå°±æ˜¯MVPå˜æ¢é‡Œé¢çš„modelï¼Œè¿™ä¸€çŸ©é˜µè¯´æ˜äº†æœ¬Nodeåœ¨çˆ¶ç»“ç‚¹çš„åæ ‡ç³»ä¸­æ€ä¹ˆæ‘†æ”¾ã€‚è¿™ä¸€å˜æ¢å®šä¹‰åœ¨<code>matrix</code>ä¸­ï¼ˆ16x16çš„è¡Œä¸»åºçš„çŸ©é˜µï¼‰ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥ç”¨TRSçš„æ–¹å¼ç»™å‡ºï¼Œå³åˆ†åˆ«è¯´æ˜ç§»åŠ¨translationã€æ—‹è½¬rotationå’Œç¼©æ”¾scaleã€‚translateæ˜¯ä¸ªä¸‰ç»´å‘é‡ï¼ˆXYZï¼‰ï¼Œrotationæ˜¯ä¸ªå››å…ƒæ•°ï¼ˆWXYZï¼‰ï¼Œscaleæ˜¯ä¸ªä¸‰ç»´å‘é‡ã€‚</p>
<blockquote>
<p>glTFçš„åæ ‡ç³»é‡‡ç”¨å³æ‰‹ç³»ï¼Œå‘ä¸Šä¸ºYã€‚OpenGLåˆ™æ˜¯å·¦æ‰‹ç³»ï¼Œå› æ­¤å¦‚æœ</p>
</blockquote>
<p>ä¸‰è§’å½¢çš„é¡¶ç‚¹æ•°æ®å­˜æ”¾åœ¨Bufferå½“ä¸­ï¼ŒåŒä¸€ä¸ªBufferå¯ä»¥ç”¨ä¸åŒçš„æ–¹å¼çš„æ–¹å¼çœ‹å¾…ï¼Œä¹Ÿå°±æ˜¯BufferViewï¼ˆç±»ä¼¼Vulkançš„BufferViewï¼‰ã€‚Accessorå®šä¹‰äº†æˆ‘ä»¬æ€æ ·è®¿é—®BufferViewï¼ˆæ¶‰åŠoffsetã€strideã€æ•°æ®ç±»å‹ç­‰ç­‰ï¼Œå’Œå®šä¹‰VAOæ—¶è¦è€ƒè™‘çš„å¾ˆåƒï¼‰ã€‚Bufferä¸­çš„æ•°æ®å¯ä»¥ç›´æ¥åœ¨æ–‡ä»¶ä¸­ç”¨base64ç¼–ç ç»™å‡ºï¼Œä¹Ÿå¯ä»¥ç»™å®šä¸€ä¸ªURIï¼ˆå¯ä»¥ç†è§£ä¸ºæ–‡ä»¶çš„è·¯å¾„ï¼‰å¼•ç”¨ä¸€ä¸ª<code>.bin</code>æ–‡ä»¶ã€‚</p>
<p>é¡¶ç‚¹æ•°æ®ä¸€èˆ¬å°±æ˜¯POSITIONä½ç½®ã€NORMALæ³•å‘é‡ã€TEXCOORDçº¹ç†åæ ‡ï¼Œè¿™ä¸‰è€…å¯¹åº”çš„Accessoréƒ½ä¼šåœ¨Primitiveå½“ä¸­æŒ‡æ˜ã€‚Primitiveè¿˜è¦ç»™å‡ºé¡¶ç‚¹ç´¢å¼•å¯¹åº”çš„Accessorï¼ˆå¯¹åº”æˆ‘ä»¬è°ƒç”¨draw
callæ—¶è¦ç»‘å®šçš„ç´¢å¼•ç¼“å†²ï¼‰ã€‚</p>
<p>æ¯ä¸ªPrimitiveä¸€èˆ¬æœ‰è‡ªå·±çš„Materialã€‚æ¯ä¸ªæè´¨æœ‰å¯èƒ½æœ‰å¯¹åº”çš„Textureã€‚Textureåˆå¼•ç”¨å¯¹åº”çš„Samplerå’ŒImageã€‚Samplerè¯´æ˜æ”¾å¤§/ç¼©å°çš„æ—¶å€™é‡‡ç”¨çš„æ’å€¼æ–¹å¼ã€çº¹ç†åæ ‡è¶…è¿‡<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mo>âˆ’</mo><mn>1</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[-1, 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">âˆ’</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>å¦‚ä½•å¤„ç†ã€‚Imageåˆ™å°±æ˜¯è´´å›¾ï¼Œä¸€èˆ¬ä¹Ÿæ˜¯ç”¨URIåº”ç”¨å¤–éƒ¨çš„å›¾ç‰‡æ–‡ä»¶ã€‚ï¼ˆå›¾åŒæ ·æ¥è‡ªgltf
tutorialï¼‰</p>
<figure>
<img src="attachment/98de29222ffc2d721b909e96abca529b.png"
alt="URIå¼•ç”¨å¤–éƒ¨æ–‡ä»¶" />
<figcaption aria-hidden="true">URIå¼•ç”¨å¤–éƒ¨æ–‡ä»¶</figcaption>
</figure>
<p>Sceneã€Nodeã€Meshã€Materialã€Textureã€Imageéƒ½å¯ä»¥æœ‰è‡ªå·±çš„<code>name</code>ã€‚</p>
<p>æ˜¾ç„¶ï¼ŒglTFæ¯”objè¿™ç±»â€œå•çº¯â€çš„æ ¼å¼å¤æ‚å¾ˆå¤šï¼ˆç”šè‡³å¯ä»¥è¯´æ²¡æœ‰å¯æ¯”æ€§ï¼‰ï¼Œå¦‚æœå¯¹å…¶åŸºæœ¬æ¦‚å¿µæ²¡æœ‰äº†è§£ï¼Œè°ƒåº“çš„æ—¶å€™å¾ˆå¯èƒ½ä¼šçœ‹ä¸æ‡‚APIï¼Œå¾ˆéš¾æŠŠå®ƒç”»åˆ°OpenGLé‡Œé¢ã€‚</p>
<h2 id="openglçš„ç®€å•å°è£…">OpenGLçš„ç®€å•å°è£…</h2>
<p>ä¸ºäº†æœ€åä»£ç èƒ½å¤Ÿç›¸å¯¹å¹²å‡€ç®€æ´ï¼Œå…ˆå¯¹OpenGLåšç‚¹ç®€å•çš„å°è£…ã€‚æœ¬èŠ‚çš„å­˜åœ¨çº¯ç²¹æ˜¯ä¸ºäº†ç®€åŒ–ä¸‹ä¸€èŠ‚çš„ä»£ç ã€‚è¯¦è§
<a
href="https://github.com/fpg2012/QuickOpenGL">fpg2012/QuickOpenGL</a></p>
<h4 id="application">Application</h4>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">QuickGLApplication</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">QuickGLApplication</span><span class="p">();</span><span class="w"> </span><span class="c1">// åˆå§‹åŒ–glfw</span>
<span class="w">    </span><span class="o">~</span><span class="n">QuickGLApplication</span><span class="p">();</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">main_loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gltf_scene</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;no gltf scene&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">            </span><span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// åˆå§‹åŒ–camera, gltf_sceneç­‰ç­‰</span>

<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">glfwWindowShouldClose</span><span class="p">(</span><span class="n">window</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 1. æ›´æ–° t</span>
<span class="w">            </span><span class="c1">// 2. æ›´æ–°å˜æ¢çŸ©é˜µ</span>
<span class="w">            </span><span class="c1">// 3. æ¸²æŸ“åˆ°shadow map</span>
<span class="w">            </span><span class="c1">// 4. çœŸæ­£çš„æ¸²æŸ“</span>

<span class="w">            </span><span class="n">glfwSwapBuffers</span><span class="p">(</span><span class="n">window</span><span class="p">);</span>
<span class="w">            </span><span class="n">glfwPollEvents</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// å¤„ç†ä¸€äº›åˆ—glfwä¼ æ¥çš„äº‹ä»¶</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">framebuffer_size_callback</span><span class="p">(</span><span class="n">GLFWwindow</span><span class="o">*</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="p">);</span>

<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">scroll_callback</span><span class="p">(</span><span class="n">GLFWwindow</span><span class="o">*</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">xoffset</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">yoffset</span><span class="p">);</span>

<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">key_callback</span><span class="p">(</span><span class="n">GLFWwindow</span><span class="o">*</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">scancode</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mods</span><span class="p">);</span>

<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">cursor_position_callback</span><span class="p">(</span><span class="n">GLFWwindow</span><span class="o">*</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">xpos</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">ypos</span><span class="p">);</span>

<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">mouse_button_callback</span><span class="p">(</span><span class="n">GLFWwindow</span><span class="o">*</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">button</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mods</span><span class="p">);</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">GLFWwindow</span><span class="o">*</span><span class="w"> </span><span class="n">window</span><span class="p">;</span>
<span class="w">    </span><span class="n">Camera</span><span class="w"> </span><span class="n">camera</span><span class="p">;</span>
<span class="w">    </span><span class="n">GLuint</span><span class="w"> </span><span class="n">viewport_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1080</span><span class="p">,</span><span class="w"> </span><span class="n">viewport_height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">720</span><span class="p">;</span>
<span class="w">    </span><span class="n">GLuint</span><span class="w"> </span><span class="n">shadow_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2048</span><span class="p">,</span><span class="w"> </span><span class="n">shadow_height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2048</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">GLTFScene</span><span class="o">&gt;</span><span class="w"> </span><span class="n">gltf_scene</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>

<h4 id="shaderå’Œshaderprogram">Shaderå’ŒShaderProgram</h4>
<p>è¯»å–ç€è‰²å™¨æ–‡ä»¶çš„å†…å®¹ç„¶åç¼–è¯‘ã€‚ææ„çš„æ—¶å€™é¡ºä¾¿æŠŠshaderé‡Šæ”¾æ‰ã€‚</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Shader</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">GLuint</span><span class="w"> </span><span class="n">handle</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">source</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//char *source = nullptr;</span>
<span class="w">    </span><span class="n">GLint</span><span class="w"> </span><span class="n">success</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">info_log</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>

<span class="w">    </span><span class="n">Shader</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">GLenum</span><span class="w"> </span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">ifstream</span><span class="w"> </span><span class="nf">ifs</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">ate</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ifs</span><span class="p">.</span><span class="n">is_open</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;failed to open file&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifs</span><span class="p">.</span><span class="n">tellg</span><span class="p">();</span>
<span class="w">        </span><span class="n">ifs</span><span class="p">.</span><span class="n">seekg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">beg</span><span class="p">);</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">stringstream</span><span class="w"> </span><span class="n">ss</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">ifs</span><span class="p">.</span><span class="n">rdbuf</span><span class="p">();</span>
<span class="w">        </span><span class="n">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
<span class="w">        </span><span class="n">ifs</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">source_c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">source</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span>
<span class="w">        </span><span class="n">init</span><span class="p">(</span><span class="n">source_c</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="o">~</span><span class="n">Shader</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">success</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GL_TRUE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">glDeleteShader</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="n">GLenum</span><span class="w"> </span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">glCreateShader</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>

<span class="w">        </span><span class="n">glShaderSource</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">        </span><span class="n">glCompileShader</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>

<span class="w">        </span><span class="n">glGetShaderiv</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="n">GL_COMPILE_STATUS</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">success</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">success</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">GL_TRUE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">glGetShaderInfoLog</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="mi">1024</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">info_log</span><span class="p">);</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;failed to compile shader: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">info_log</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</pre></div>

<p>é“¾æ¥Vertex Shaderå’ŒFragment
Shaderã€‚éœ€è¦ä½¿ç”¨çš„æ—¶å€™ç›´æ¥è°ƒç”¨<code>use</code>å‡½æ•°ã€‚</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ShaderProgram</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">GLuint</span><span class="w"> </span><span class="n">handle</span><span class="p">;</span>
<span class="w">    </span><span class="n">GLint</span><span class="w"> </span><span class="n">success</span><span class="p">;</span>

<span class="w">    </span><span class="n">ShaderProgram</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Shader</span><span class="o">&amp;</span><span class="w"> </span><span class="n">vert</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Shader</span><span class="o">&amp;</span><span class="w"> </span><span class="n">frag</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">glCreateProgram</span><span class="p">();</span>
<span class="w">        </span><span class="n">glAttachShader</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="n">vert</span><span class="p">.</span><span class="n">handle</span><span class="p">);</span>
<span class="w">        </span><span class="n">glAttachShader</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="n">frag</span><span class="p">.</span><span class="n">handle</span><span class="p">);</span>
<span class="w">        </span><span class="n">glLinkProgram</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
<span class="w">        </span><span class="n">glGetProgramiv</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="n">GL_LINK_STATUS</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">success</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">char</span><span class="w"> </span><span class="n">info_log</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
<span class="w">            </span><span class="n">glGetProgramInfoLog</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="mi">1024</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">info_log</span><span class="p">);</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">info_log</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">use</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">glUseProgram</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</pre></div>

<p>è¿™éƒ¨åˆ†LearnOpenGLæœ‰ä¸ªæ›´å®Œå¤‡çš„å°è£…ï¼Œå¯ä»¥ç›´æ¥å‚è€ƒé‚£ä¸ªã€‚</p>
<h4 id="textureå’Œmaterial">Textureå’ŒMaterial</h4>
<p>å¯ä»¥ä½¿ç”¨stb_imageæŠŠå›¾åƒå†…å®¹åŠ è½½åˆ°å†…å­˜ã€‚ä¸è¿‡è¿™é‡Œå‡è®¾å·²ç»åŠ è½½å¥½äº†ï¼Œç›´æ¥æŠŠå­—èŠ‚æ•°ç»„ä¼ è¿›æ¥ã€‚</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Texture</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">GLuint</span><span class="w"> </span><span class="n">handle</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// çœç•¥å‡ ä¸ªåˆ«çš„æ„é€ å‡½æ•°</span>

<span class="w">    </span><span class="n">Texture</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bytes</span><span class="p">,</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="p">,</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">wrap_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GL_CLAMP_TO_EDGE</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">wrap_t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GL_CLAMP_TO_EDGE</span><span class="p">,</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">min_filter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GL_LINEAR</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mag_filter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GL_LINEAR</span><span class="p">,</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">component_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GL_UNSIGNED_BYTE</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GL_RGBA</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">glGenTextures</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">handle</span><span class="p">);</span>
<span class="w">        </span><span class="n">glBindTexture</span><span class="p">(</span><span class="n">GL_TEXTURE_2D</span><span class="p">,</span><span class="w"> </span><span class="n">handle</span><span class="p">);</span>
<span class="w">        </span><span class="n">glTexImage2D</span><span class="p">(</span><span class="n">GL_TEXTURE_2D</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="p">,</span><span class="w"> </span><span class="n">component_type</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
<span class="w">        </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">use</span><span class="p">(</span><span class="n">GLenum</span><span class="w"> </span><span class="n">texture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GL_TEXTURE0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">glActiveTexture</span><span class="p">(</span><span class="n">texture</span><span class="p">);</span>
<span class="w">        </span><span class="n">glBindTexture</span><span class="p">(</span><span class="n">GL_TEXTURE_2D</span><span class="p">,</span><span class="w"> </span><span class="n">handle</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</pre></div>

<p>Materialåˆ™ç”±ShaderProgramå’ŒTextureç»„åˆè€Œæˆã€‚åœ¨ä½¿ç”¨æè´¨çš„æ—¶å€™ï¼Œä½¿ç”¨ç€è‰²å™¨ç¨‹åºï¼Œç»‘å®šæè´¨ï¼Œè®¾ç½®éœ€è¦çš„uniformå˜é‡ã€‚è¿™é‡Œæˆ‘å®ç°äº†ä¸¤ç§æè´¨ï¼Œçº¯è‰²å’ŒBlinn-Phongã€‚</p>
<p>shaderçš„ç¼–å†™å’Œæœ¬æ–‡æ— å…³ï¼Œåœ¨æ­¤ä¸è¡¨ï¼Œå¯ä»¥ç›´æ¥å»githubçœ‹ã€‚</p>
<div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">Material</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// å¯¹åº”glTFå½“ä¸­çš„alphaMode</span>
<span class="w">    </span><span class="c1">// ä¸ºäº†å¾—åˆ°ç›¸å¯¹æ­£ç¡®çš„ç»“æœï¼Œåº”è¯¥ä»¥ä¸åŒçš„æ–¹å¼å¯¹å¾…åŠé€æ˜ç‰©ä½“å’Œä¸é€æ˜ç‰©ä½“</span>
<span class="w">    </span><span class="c1">// ä¸‹æ–‡RenderQueueä¸€èŠ‚ä¼šè¯´æ˜</span>
<span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="nc">AlphaMode</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">OPAQUE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="c1">// ä¸é€æ˜</span>
<span class="w">        </span><span class="n">MASK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="c1">// æˆ‘æ²¡å®ç°</span>
<span class="w">        </span><span class="n">BLEND</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="c1">// åŠé€æ˜</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="n">Material</span><span class="p">(</span><span class="n">AlphaMode</span><span class="w"> </span><span class="n">alpha_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OPAQUE</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">alpha_mode</span><span class="p">(</span><span class="n">alpha_mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">apply</span><span class="p">(</span><span class="n">glm</span><span class="o">::</span><span class="n">mat4</span><span class="w"> </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Camera</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cam</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">AlphaMode</span><span class="w"> </span><span class="n">alpha_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OPAQUE</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// çº¯è‰²</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">SimpleColorMaterial</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Material</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">SimpleColorMaterial</span><span class="p">(</span><span class="n">glm</span><span class="o">::</span><span class="n">vec3</span><span class="w"> </span><span class="n">color</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">color</span><span class="p">(</span><span class="n">color</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shader_program</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">shader_program</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load_shader</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">apply</span><span class="p">(</span><span class="n">glm</span><span class="o">::</span><span class="n">mat4</span><span class="w"> </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Camera</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cam</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">shader_program</span><span class="o">-&gt;</span><span class="n">use</span><span class="p">();</span>

<span class="w">        </span><span class="n">GLuint</span><span class="w"> </span><span class="n">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">glGetUniformLocation</span><span class="p">(</span><span class="n">shader_program</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;model&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ShaderProgram</span><span class="o">&gt;</span><span class="w"> </span><span class="n">load_shader</span><span class="p">();</span>

<span class="w">    </span><span class="n">glm</span><span class="o">::</span><span class="n">vec3</span><span class="w"> </span><span class="n">color</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// åŒä¸€ç§Materialåªéœ€è¦ä¸€ä¸ªShaderProgramï¼Œå› æ­¤ç”¨staticå˜é‡</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ShaderProgram</span><span class="o">&gt;</span><span class="w"> </span><span class="n">shader_program</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// å¸¦çº¹ç†è´´å›¾çš„Blinn-Phongæè´¨</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">PhongMaterial</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Material</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">k_ambient</span><span class="p">,</span><span class="w"> </span><span class="n">k_diffuse</span><span class="p">,</span><span class="w"> </span><span class="n">k_specular</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">phong_exponent</span><span class="p">;</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ShaderProgram</span><span class="o">&gt;</span><span class="w"> </span><span class="n">shader_program</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Texture</span><span class="o">&gt;</span><span class="w"> </span><span class="n">texture</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Texture</span><span class="o">&gt;</span><span class="w"> </span><span class="n">shadow_map</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">PointLight</span><span class="o">&gt;</span><span class="w"> </span><span class="n">light</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// åŒä¸€ç§Materialåªéœ€è¦ä¸€ä¸ªShaderProgramï¼Œå› æ­¤ç”¨staticå˜é‡</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ShaderProgram</span><span class="o">&gt;</span><span class="w"> </span><span class="n">default_shader_program</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>

<span class="w">    </span><span class="n">PhongMaterial</span><span class="p">(</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ShaderProgram</span><span class="o">&gt;</span><span class="w"> </span><span class="n">shader_program</span><span class="p">,</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Texture</span><span class="o">&gt;</span><span class="w"> </span><span class="n">texture</span><span class="p">,</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">PointLight</span><span class="o">&gt;</span><span class="w"> </span><span class="n">light</span><span class="p">,</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Texture</span><span class="o">&gt;</span><span class="w"> </span><span class="n">shadow_map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span>
<span class="w">        </span><span class="n">AlphaMode</span><span class="w"> </span><span class="n">alpha_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Material</span><span class="o">::</span><span class="n">OPAQUE</span><span class="p">,</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">phong_exponent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">32.0f</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">k_ambient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">.2f</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">k_diffuse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">k_specular</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5f</span><span class="p">)</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">shader_program</span><span class="p">(</span><span class="n">shader_program</span><span class="p">),</span><span class="w"> </span><span class="n">texture</span><span class="p">(</span><span class="n">texture</span><span class="p">),</span><span class="w"> </span><span class="n">light</span><span class="p">(</span><span class="n">light</span><span class="p">),</span><span class="w"> </span><span class="n">shadow_map</span><span class="p">(</span><span class="n">shadow_map</span><span class="p">),</span>
<span class="w">        </span><span class="n">phong_exponent</span><span class="p">(</span><span class="n">phong_exponent</span><span class="p">),</span><span class="w"> </span><span class="n">k_ambient</span><span class="p">(</span><span class="n">k_ambient</span><span class="p">),</span><span class="w"> </span><span class="n">k_diffuse</span><span class="p">(</span><span class="n">k_diffuse</span><span class="p">),</span><span class="w"> </span><span class="n">k_specular</span><span class="p">(</span><span class="n">k_specular</span><span class="p">),</span>
<span class="w">        </span><span class="n">Material</span><span class="p">(</span><span class="n">alpha_mode</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shader_program</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">default_shader_program</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">shader_program</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load_shader</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">apply</span><span class="p">(</span><span class="n">glm</span><span class="o">::</span><span class="n">mat4</span><span class="w"> </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Camera</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cam</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">texture</span><span class="o">-&gt;</span><span class="n">use</span><span class="p">(</span><span class="n">GL_TEXTURE0</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shadow_map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">shadow_map</span><span class="o">-&gt;</span><span class="n">use</span><span class="p">(</span><span class="n">GL_TEXTURE1</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">shader_program</span><span class="o">-&gt;</span><span class="n">use</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// è®¾ç½®uniformå˜é‡</span>
<span class="w">        </span><span class="n">GLuint</span><span class="w"> </span><span class="n">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">glGetUniformLocation</span><span class="p">(</span><span class="n">shader_program</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;model&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ShaderProgram</span><span class="o">&gt;</span><span class="w"> </span><span class="n">load_shader</span><span class="p">();</span>
<span class="p">};</span>
</pre></div>

<h4 id="camera">Camera</h4>
<p>ç›¸æœºç±»ï¼Œæ–¹ä¾¿ç®¡ç†<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span>å’Œ<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span>ä¸¤ä¸ªçŸ©é˜µã€‚</p>
<div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">Camera</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">fovy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">glm</span><span class="o">::</span><span class="n">radians</span><span class="p">(</span><span class="mf">45.0f</span><span class="p">);</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">aspect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">VIEWPORT_WIDTH</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">VIEWPORT_HEIGHT</span><span class="p">;</span>
<span class="w">    </span><span class="n">glm</span><span class="o">::</span><span class="n">vec3</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">glm</span><span class="o">::</span><span class="n">vec3</span><span class="p">(</span><span class="mf">.0f</span><span class="p">,</span><span class="w"> </span><span class="mf">3.0f</span><span class="p">,</span><span class="w"> </span><span class="mf">3.0f</span><span class="p">);</span>
<span class="w">    </span><span class="n">glm</span><span class="o">::</span><span class="n">vec3</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">glm</span><span class="o">::</span><span class="n">vec3</span><span class="p">(</span><span class="mf">.0f</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">,</span><span class="w"> </span><span class="mf">.0f</span><span class="p">);</span>
<span class="w">    </span><span class="n">glm</span><span class="o">::</span><span class="n">vec3</span><span class="w"> </span><span class="n">look_at</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">glm</span><span class="o">::</span><span class="n">vec3</span><span class="p">(</span><span class="mf">.0f</span><span class="p">,</span><span class="w"> </span><span class="mf">.0f</span><span class="p">,</span><span class="w"> </span><span class="mf">.0f</span><span class="p">);</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">zNear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">zFar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">100.0f</span><span class="p">;</span>

<span class="w">    </span><span class="n">glm</span><span class="o">::</span><span class="n">mat4</span><span class="w"> </span><span class="nf">project</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">glm</span><span class="o">::</span><span class="n">perspective</span><span class="p">(</span><span class="n">fovy</span><span class="p">,</span><span class="w"> </span><span class="n">aspect</span><span class="p">,</span><span class="w"> </span><span class="n">zNear</span><span class="p">,</span><span class="w"> </span><span class="n">zFar</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">glm</span><span class="o">::</span><span class="n">mat4</span><span class="w"> </span><span class="nf">view</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">glm</span><span class="o">::</span><span class="n">lookAt</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">look_at</span><span class="p">,</span><span class="w"> </span><span class="n">up</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</pre></div>

<h2 id="ä½¿ç”¨tinygltfåŠ è½½åœºæ™¯">ä½¿ç”¨tinygltfåŠ è½½åœºæ™¯</h2>
<p>è¿™é‡Œé€‰ç”¨<a
href="https://github.com/syoyo/tinygltf">tinygltf</a>æ¥åŠ è½½glTFæ¨¡å‹ï¼Œå› ä¸ºè¿™ä¸ªåº“çœ‹èµ·æ¥æœ€ç®€å•ã€‚</p>
<p>tinygltfæ–‡æ¡£å¾ˆçƒ‚ï¼Œå¹¸å¥½æ­¤åº“åŸºæœ¬å°±åªæ˜¯æŠŠJSONè§£ææˆå®ƒå®šä¹‰çš„ç»“æ„ä½“ï¼ŒåŠŸèƒ½ç®€å•ã€ä»£ç ä¸é•¿ï¼Œç›´æ¥çœ‹æºä»£ç æ•ˆç‡ä¹Ÿä¸ç®—å¤ªä½ã€‚è¿™ä¸ªé¡¹ç›®é‡Œè¿˜æœ‰ä¸€äº›ç¤ºä¾‹ï¼Œå…·æœ‰å°‘è®¸å‚è€ƒä»·å€¼ã€‚</p>
<p>ä¸ºäº†ä»£ç å¥½çœ‹ä¸€äº›ï¼Œæˆ‘ä»¬è¿˜æ˜¯å†åšè¿›ä¸€æ­¥çš„å°è£…ã€‚</p>
<h4 id="gltfbufferview">GLTFBufferView</h4>
<div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">GLTFBufferView</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">GLuint</span><span class="w"> </span><span class="n">handle</span><span class="p">;</span>
<span class="w">    </span><span class="n">tinygltf</span><span class="o">::</span><span class="n">BufferView</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bufv</span><span class="p">;</span>

<span class="w">    </span><span class="n">GLTFBufferView</span><span class="p">(</span><span class="n">tinygltf</span><span class="o">::</span><span class="n">BufferView</span><span class="o">&amp;</span><span class="w"> </span><span class="n">view</span><span class="p">,</span><span class="w"> </span><span class="n">tinygltf</span><span class="o">::</span><span class="n">Buffer</span><span class="o">&amp;</span><span class="w"> </span><span class="n">buffer</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">bind</span><span class="p">();</span><span class="w"> </span><span class="c1">// ç»‘å®šç¼“å†²çš„æ—¶å€™ï¼Œè°ƒè¿™ä¸ªå‡½æ•°</span>
<span class="p">};</span>
</pre></div>

<p><code>tinygltf::BufferView</code>ä¸­å·²ç»åŒ…å«äº†å»ºç«‹ä¸€ä¸ªç¼“å†²æ‰€éœ€çš„å…¨éƒ¨ä¿¡æ¯ï¼Œçœ‹èµ·æ¥æœ´å®æ— åã€‚</p>
<div class="highlight"><pre><span></span><span class="n">GLTFBufferView</span><span class="o">::</span><span class="n">GLTFBufferView</span><span class="p">(</span><span class="n">tinygltf</span><span class="o">::</span><span class="n">BufferView</span><span class="o">&amp;</span><span class="w"> </span><span class="n">view</span><span class="p">,</span><span class="w"> </span><span class="n">tinygltf</span><span class="o">::</span><span class="n">Buffer</span><span class="o">&amp;</span><span class="w"> </span><span class="n">buffer</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">bufv</span><span class="p">(</span><span class="n">view</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">glGenBuffers</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">handle</span><span class="p">);</span>
<span class="w">    </span><span class="n">glBindBuffer</span><span class="p">(</span><span class="n">view</span><span class="p">.</span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="n">handle</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// æŠŠæ•°æ®ä¼ åˆ°æ˜¾å­˜</span>
<span class="w">    </span><span class="c1">// æ³¨æ„å†…å­˜ä¸­æ•°æ®å¼€å§‹çš„æŒ‡é’ˆéœ€è¦åŠ ä¸Šbufferviewçš„offset</span>
<span class="w">    </span><span class="n">glBufferData</span><span class="p">(</span><span class="n">view</span><span class="p">.</span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="n">view</span><span class="p">.</span><span class="n">byteLength</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">view</span><span class="p">.</span><span class="n">byteOffset</span><span class="p">,</span><span class="w"> </span><span class="n">GL_STATIC_DRAW</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">GLTFBufferView</span><span class="o">::</span><span class="n">bind</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">glBindBuffer</span><span class="p">(</span><span class="n">bufv</span><span class="p">.</span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="n">handle</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<h4 id="gltfmeshå’Œgltfprimitive">GLTFMeshå’ŒGLTFPrimitive</h4>
<p>Meshç±»å¯ä»¥çœ‹æˆPrimitiveç±»çš„ä¸€ä¸ªé›†åˆã€‚æ¸²æŸ“æ—¶åªè¦è°ƒç”¨Meshçš„<code>draw</code>ä¾¿å¯æŠŠå®ƒä¸‹é¢çš„æ‰€æœ‰Primitiveå…¨éƒ¨ç”»å‡ºæ¥ã€‚</p>
<div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">GLTFMesh</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">GLTFPrimitive</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">primitives</span><span class="p">;</span>

<span class="w">    </span><span class="n">GLTFMesh</span><span class="p">(</span><span class="n">tinygltf</span><span class="o">::</span><span class="n">Model</span><span class="o">&amp;</span><span class="w"> </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">tinygltf</span><span class="o">::</span><span class="n">Mesh</span><span class="o">&amp;</span><span class="w"> </span><span class="n">mesh</span><span class="p">,</span><span class="w"> </span><span class="n">GLTFScene</span><span class="o">*</span><span class="w"> </span><span class="n">scene</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// å…¶å®å°±æ˜¯æŠŠæ‰€æœ‰Primitiveçš„drawéƒ½è°ƒç”¨ä¸€é</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Camera</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cam</span><span class="p">,</span><span class="w"> </span><span class="n">glm</span><span class="o">::</span><span class="n">mat4</span><span class="o">&amp;</span><span class="w"> </span><span class="n">transform</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Material</span><span class="o">&gt;</span><span class="w"> </span><span class="n">material</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">GLTFPrimitive</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Material</span><span class="o">&gt;</span><span class="w"> </span><span class="n">default_material</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="w">    </span><span class="n">GLuint</span><span class="w"> </span><span class="n">mode</span><span class="p">;</span><span class="w"> </span><span class="c1">// ç”»ä¸‰è§’å½¢çš„æ¨¡å¼ï¼Œä¸€èˆ¬æ˜¯GL_TRIANGLES</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">GLTFBufferView</span><span class="o">&gt;</span><span class="w"> </span><span class="n">index_bufv</span><span class="p">,</span><span class="w"> </span><span class="n">pos_bufv</span><span class="p">,</span><span class="w"> </span><span class="n">normal_bufv</span><span class="p">,</span><span class="w"> </span><span class="n">texcoord_bufv</span><span class="p">;</span>
<span class="w">    </span><span class="n">tinygltf</span><span class="o">::</span><span class="n">Accessor</span><span class="o">*</span><span class="w"> </span><span class="n">index_acc</span><span class="p">;</span>
<span class="w">    </span><span class="n">GLuint</span><span class="w"> </span><span class="n">vao</span><span class="p">;</span><span class="w"> </span><span class="c1">// Vertex Array Object</span>

<span class="w">    </span><span class="c1">// æ„é€ å‡½æ•°å‚æ•°åˆ—è¡¨ç›¸å¯¹æœ‰ç‚¹å¤æ‚ï¼Œè§ä¸‹é¢çš„å®ç°</span>
<span class="w">    </span><span class="n">GLTFPrimitive</span><span class="p">(</span><span class="n">tinygltf</span><span class="o">::</span><span class="n">Model</span><span class="o">&amp;</span><span class="w"> </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">tinygltf</span><span class="o">::</span><span class="n">Primitive</span><span class="o">&amp;</span><span class="w"> </span><span class="n">primitive</span><span class="p">,</span><span class="w"> </span><span class="n">GLTFScene</span><span class="o">*</span><span class="w"> </span><span class="n">scene</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Camera</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cam</span><span class="p">,</span><span class="w"> </span><span class="n">glm</span><span class="o">::</span><span class="n">mat4</span><span class="o">&amp;</span><span class="w"> </span><span class="n">transform</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Material</span><span class="o">&gt;</span><span class="w"> </span><span class="n">material</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>

<p>Primitiveçš„æ„é€ å‡½æ•°ç›¸å¯¹é•¿ä¸€äº›ã€‚</p>
<div class="highlight"><pre><span></span><span class="n">GLTFPrimitive</span><span class="o">::</span><span class="n">GLTFPrimitive</span><span class="p">(</span><span class="n">tinygltf</span><span class="o">::</span><span class="n">Model</span><span class="o">&amp;</span><span class="w"> </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">tinygltf</span><span class="o">::</span><span class="n">Primitive</span><span class="o">&amp;</span><span class="w"> </span><span class="n">primitive</span><span class="p">,</span><span class="w"> </span><span class="n">GLTFScene</span><span class="o">*</span><span class="w"> </span><span class="n">scene</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// åˆ›å»ºVAO</span>
<span class="w">    </span><span class="n">glGenVertexArrays</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vao</span><span class="p">);</span>
<span class="w">    </span><span class="n">glBindVertexArray</span><span class="p">(</span><span class="n">vao</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// è·å–å‡ ä¸ªå¿…è¦çš„Accessorå’Œmode</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">pos_acc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">model</span><span class="p">.</span><span class="n">accessors</span><span class="p">[</span><span class="n">primitive</span><span class="p">.</span><span class="n">attributes</span><span class="p">[</span><span class="s">&quot;POSITION&quot;</span><span class="p">]];</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">normal_acc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">model</span><span class="p">.</span><span class="n">accessors</span><span class="p">[</span><span class="n">primitive</span><span class="p">.</span><span class="n">attributes</span><span class="p">[</span><span class="s">&quot;NORMAL&quot;</span><span class="p">]];</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">texcoord_acc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">model</span><span class="p">.</span><span class="n">accessors</span><span class="p">[</span><span class="n">primitive</span><span class="p">.</span><span class="n">attributes</span><span class="p">[</span><span class="s">&quot;TEXCOORD_0&quot;</span><span class="p">]];</span>
<span class="w">    </span><span class="n">index_acc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">model</span><span class="p">.</span><span class="n">accessors</span><span class="p">[</span><span class="n">primitive</span><span class="p">.</span><span class="n">indices</span><span class="p">];</span>
<span class="w">    </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">primitive</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// é€šè¿‡AccessoræŸ¥BufferView</span>
<span class="w">    </span><span class="c1">// è¿™å°±æ˜¯ä¸ºå•¥è¦æŠŠsceneç»™ä¼ è¿›æ¥</span>
<span class="w">    </span><span class="c1">// GLTFSceneçš„å®šä¹‰è§ä¸‹æ–‡</span>
<span class="w">    </span><span class="n">index_bufv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scene</span><span class="o">-&gt;</span><span class="n">bufferViews</span><span class="p">[</span><span class="n">index_acc</span><span class="o">-&gt;</span><span class="n">bufferView</span><span class="p">];</span>
<span class="w">    </span><span class="n">pos_bufv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scene</span><span class="o">-&gt;</span><span class="n">bufferViews</span><span class="p">[</span><span class="n">pos_acc</span><span class="o">-&gt;</span><span class="n">bufferView</span><span class="p">];</span>
<span class="w">    </span><span class="n">normal_bufv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scene</span><span class="o">-&gt;</span><span class="n">bufferViews</span><span class="p">[</span><span class="n">normal_acc</span><span class="o">-&gt;</span><span class="n">bufferView</span><span class="p">];</span>
<span class="w">    </span><span class="n">texcoord_bufv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scene</span><span class="o">-&gt;</span><span class="n">bufferViews</span><span class="p">[</span><span class="n">texcoord_acc</span><span class="o">-&gt;</span><span class="n">bufferView</span><span class="p">];</span>

<span class="w">    </span><span class="n">index_bufv</span><span class="o">-&gt;</span><span class="n">bind</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// è®¾ç½®é¡¶ç‚¹ä½ç½®çš„è®¿é—®æ–¹å¼</span>
<span class="w">    </span><span class="n">pos_bufv</span><span class="o">-&gt;</span><span class="n">bind</span><span class="p">();</span>
<span class="w">    </span><span class="n">glVertexAttribPointer</span><span class="p">(</span>
<span class="w">        </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="c1">// åœ¨shaderé‡Œé¢locationæ˜¯0</span>
<span class="w">        </span><span class="n">tinygltf</span><span class="o">::</span><span class="n">GetNumComponentsInType</span><span class="p">(</span><span class="n">pos_acc</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">),</span><span class="w">  </span><span class="c1">// ä¸€èˆ¬æ˜¯3ï¼Œå› ä¸ºé¡¶ç‚¹åæ ‡ç±»å‹æ˜¯vec3</span>
<span class="w">        </span><span class="n">pos_acc</span><span class="o">-&gt;</span><span class="n">componentType</span><span class="p">,</span><span class="w"> </span><span class="c1">// ä¸€èˆ¬æ˜¯GL_FLOAT</span>
<span class="w">        </span><span class="n">pos_acc</span><span class="o">-&gt;</span><span class="n">normalized</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">GL_TRUE</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">GL_FALSE</span><span class="p">,</span>
<span class="w">        </span><span class="n">pos_acc</span><span class="o">-&gt;</span><span class="n">ByteStride</span><span class="p">(</span><span class="n">pos_bufv</span><span class="o">-&gt;</span><span class="n">bufv</span><span class="p">),</span><span class="w"> </span><span class="c1">// è°ƒç”¨ByteStrideå‡½æ•°ï¼Œçœå¾—è‡ªå·±ç®—stride</span>
<span class="w">        </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="mi">0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pos_acc</span><span class="o">-&gt;</span><span class="n">byteOffset</span><span class="p">)</span><span class="w"> </span><span class="c1">// è®°å¾—åŠ ä¸ŠAccessorçš„offset</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="n">glEnableVertexAttribArray</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// è®¾ç½®æ³•å‘é‡çš„è®¿é—®æ–¹å¼</span>
<span class="w">    </span><span class="n">normal_bufv</span><span class="o">-&gt;</span><span class="n">bind</span><span class="p">();</span>
<span class="w">    </span><span class="n">glVertexAttribPointer</span><span class="p">(</span>
<span class="w">        </span><span class="mi">2</span><span class="p">,</span>
<span class="w">        </span><span class="n">tinygltf</span><span class="o">::</span><span class="n">GetNumComponentsInType</span><span class="p">(</span><span class="n">normal_acc</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">),</span>
<span class="w">        </span><span class="n">normal_acc</span><span class="o">-&gt;</span><span class="n">componentType</span><span class="p">,</span>
<span class="w">        </span><span class="n">normal_acc</span><span class="o">-&gt;</span><span class="n">normalized</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">GL_TRUE</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">GL_FALSE</span><span class="p">,</span>
<span class="w">        </span><span class="n">normal_acc</span><span class="o">-&gt;</span><span class="n">ByteStride</span><span class="p">(</span><span class="n">normal_bufv</span><span class="o">-&gt;</span><span class="n">bufv</span><span class="p">),</span>
<span class="w">        </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="mi">0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">normal_acc</span><span class="o">-&gt;</span><span class="n">byteOffset</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="n">glEnableVertexAttribArray</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// è®¾ç½®çº¹ç†åæ ‡çš„è®¿é—®æ–¹å¼</span>
<span class="w">    </span><span class="n">texcoord_bufv</span><span class="o">-&gt;</span><span class="n">bind</span><span class="p">();</span>
<span class="w">    </span><span class="n">glVertexAttribPointer</span><span class="p">(</span>
<span class="w">        </span><span class="mi">1</span><span class="p">,</span>
<span class="w">        </span><span class="n">tinygltf</span><span class="o">::</span><span class="n">GetNumComponentsInType</span><span class="p">(</span><span class="n">texcoord_acc</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">),</span><span class="w"> </span><span class="c1">// ä¸€èˆ¬æ˜¯2ï¼Œå› ä¸ºçº¹ç†åæ ‡ç±»å‹ä¸€èˆ¬æ˜¯vec2</span>
<span class="w">        </span><span class="n">texcoord_acc</span><span class="o">-&gt;</span><span class="n">componentType</span><span class="p">,</span>
<span class="w">        </span><span class="n">texcoord_acc</span><span class="o">-&gt;</span><span class="n">normalized</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">GL_TRUE</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">GL_FALSE</span><span class="p">,</span>
<span class="w">        </span><span class="n">texcoord_acc</span><span class="o">-&gt;</span><span class="n">ByteStride</span><span class="p">(</span><span class="n">texcoord_bufv</span><span class="o">-&gt;</span><span class="n">bufv</span><span class="p">),</span>
<span class="w">        </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="mi">0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">texcoord_acc</span><span class="o">-&gt;</span><span class="n">byteOffset</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="n">glEnableVertexAttribArray</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// gltfä¸­åˆ¶å®šçš„æè´¨æˆä¸ºé»˜è®¤æè´¨</span>
<span class="w">    </span><span class="n">default_material</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scene</span><span class="o">-&gt;</span><span class="n">materials</span><span class="p">[</span><span class="n">primitive</span><span class="p">.</span><span class="n">material</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>

<p>ç„¶åæ˜¯æœ´å®æ— åçš„draw callã€‚</p>
<div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">GLTFPrimitive::draw</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Camera</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cam</span><span class="p">,</span><span class="w"> </span><span class="n">glm</span><span class="o">::</span><span class="n">mat4</span><span class="o">&amp;</span><span class="w"> </span><span class="n">transform</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Material</span><span class="o">&gt;</span><span class="w"> </span><span class="n">material</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ä¸ç»™å®šæè´¨ï¼Œå°±ç”¨é»˜è®¤æè´¨</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">material</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">material</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">default_material</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">material</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span>
<span class="w">    </span><span class="n">material</span><span class="o">-&gt;</span><span class="n">apply</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span><span class="w"> </span><span class="n">cam</span><span class="p">);</span>

<span class="w">    </span><span class="n">glBindVertexArray</span><span class="p">(</span><span class="n">vao</span><span class="p">);</span>
<span class="w">    </span><span class="n">index_bufv</span><span class="o">-&gt;</span><span class="n">bind</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// ç»˜å›¾æ¨¡å¼ï¼ˆGL_TRIANGLES)ï¼Œé¡¶ç‚¹ç´¢å¼•çš„ä¸ªæ•°ï¼Œç±»å‹ï¼ˆæŸç§æ— ç¬¦å·æ•´æ•°ï¼‰ï¼Œåœ¨ç´¢å¼•ç¼“å†²ä¸­çš„åç§»é‡</span>
<span class="w">    </span><span class="n">glDrawElements</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="n">index_acc</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">index_acc</span><span class="o">-&gt;</span><span class="n">componentType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">index_acc</span><span class="o">-&gt;</span><span class="n">byteOffset</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<h4 id="gltfscene">GLTFScene</h4>
<p>æœ€åï¼Œæˆ‘ä»¬æŠŠglTFåœºæ™¯å°è£…åˆ°æˆ‘ä»¬å®šä¹‰çš„<code>GLTFScene</code>ç±»é‡Œé¢ã€‚</p>
<div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">GLTFScene</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="c1">// åŠ è½½æ¨¡å‹</span>
<span class="w">    </span><span class="n">GLTFScene</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">filename</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// åŸºæœ¬çš„åˆå§‹åŒ–</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ShaderProgram</span><span class="o">&gt;</span><span class="w"> </span><span class="n">shader_program</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">PointLight</span><span class="o">&gt;</span><span class="w"> </span><span class="n">light</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Texture</span><span class="o">&gt;</span><span class="w"> </span><span class="n">shadow_map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// æ¸²æŸ“</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">render</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Camera</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cam</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Material</span><span class="o">&gt;</span><span class="w"> </span><span class="n">material</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// æ¸²æŸ“å•ä¸ªç»“ç‚¹</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">draw_node</span><span class="p">(</span><span class="n">tinygltf</span><span class="o">::</span><span class="n">Node</span><span class="o">&amp;</span><span class="w"> </span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Camera</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cam</span><span class="p">,</span><span class="w"> </span><span class="n">glm</span><span class="o">::</span><span class="n">mat4</span><span class="o">&amp;</span><span class="w"> </span><span class="n">transform</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Material</span><span class="o">&gt;</span><span class="w"> </span><span class="n">material</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// æ›´æ–°è¿™ä¸ªæ¨¡å‹åœ¨ä¸–ç•Œåæ ‡ä¸­çš„æ”¾ç½®æ–¹å¼ï¼ˆä¹Ÿå°±æ˜¯modelçŸ©é˜µï¼‰</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">update_matrix</span><span class="p">(</span><span class="n">glm</span><span class="o">::</span><span class="n">mat4</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mat</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// tinygltfçš„ç»“æ„ä½“</span>
<span class="w">    </span><span class="n">tinygltf</span><span class="o">::</span><span class="n">Model</span><span class="w"> </span><span class="n">model</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">warn</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// å¯¹åº”gltfçš„è´´å›¾åˆ—è¡¨</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Texture</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">textures</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// å¯¹åº”gltfçš„æè´¨åˆ—è¡¨</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Material</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">materials</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// å¯¹åº”gltfçš„bufferviewåˆ—è¡¨</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">GLTFBufferView</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">bufferViews</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// å¯¹åº”gltfçš„ç½‘æ ¼åˆ—è¡¨</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="w"> </span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">GLTFMesh</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">meshes</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// modelçŸ©é˜µ</span>
<span class="w">    </span><span class="n">glm</span><span class="o">::</span><span class="n">mat4</span><span class="w"> </span><span class="n">matrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">glm</span><span class="o">::</span><span class="n">mat4</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>

<p>åŠ è½½æ¨¡å‹å’Œtinygltfç»™çš„ç¤ºä¾‹å·®ä¸å¤šã€‚</p>
<div class="highlight"><pre><span></span><span class="n">GLTFScene</span><span class="o">::</span><span class="n">GLTFScene</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">filename</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">tinygltf</span><span class="o">::</span><span class="n">TinyGLTF</span><span class="w"> </span><span class="n">loader</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// å¦‚æœåœ¨å…¶ä»–åœ°æ–¹ä½¿ç”¨äº†stb_imageåº“ï¼Œå¹¶ä¸”ç¿»è½¬äº†çºµå‘åæ ‡ï¼Œè®°å¾—å–æ¶ˆç¿»è½¬</span>
<span class="w">    </span><span class="n">stbi_set_flip_vertically_on_load</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">filename</span><span class="p">.</span><span class="n">ends_with</span><span class="p">(</span><span class="s">&quot;.gltf&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loader</span><span class="p">.</span><span class="n">LoadASCIIFromFile</span><span class="p">(</span><span class="o">&amp;</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">err</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">warn</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">filename</span><span class="p">.</span><span class="n">ends_with</span><span class="p">(</span><span class="s">&quot;.glb&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loader</span><span class="p">.</span><span class="n">LoadBinaryFromFile</span><span class="p">(</span><span class="o">&amp;</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">err</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">warn</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">warn</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">warn</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;failed to load model &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// è¿™é‡Œå¯ä»¥æŠ›å¼‚å¸¸</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>åˆå§‹åŒ–æ˜¯ä¸ºäº†å»ºç«‹<code>textures</code>ã€<code>materials</code>ã€<code>bufferViews</code>ã€<code>meshes</code>å››ä¸ª<code>vector</code>ã€‚</p>
<div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">GLTFScene::init</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ShaderProgram</span><span class="o">&gt;</span><span class="w"> </span><span class="n">shader_program</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">PointLight</span><span class="o">&gt;</span><span class="w"> </span><span class="n">light</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Texture</span><span class="o">&gt;</span><span class="w"> </span><span class="n">shadow_map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// æœ¬æ–‡åªå¤„ç†é»˜è®¤åœºæ™¯</span>
<span class="w">    </span><span class="n">tinygltf</span><span class="o">::</span><span class="n">Scene</span><span class="w"> </span><span class="n">scene</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">scenes</span><span class="p">[</span><span class="n">model</span><span class="p">.</span><span class="n">defaultScene</span><span class="p">];</span>
<span class="w">    </span><span class="c1">// è½½å…¥çº¹ç†</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">tinygltf</span><span class="o">::</span><span class="n">Texture</span><span class="o">&amp;</span><span class="w"> </span><span class="n">texture</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">textures</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;loading texture: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">texture</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="n">tinygltf</span><span class="o">::</span><span class="n">Image</span><span class="o">&amp;</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">images</span><span class="p">[</span><span class="n">texture</span><span class="p">.</span><span class="n">source</span><span class="p">];</span>
<span class="w">        </span><span class="n">tinygltf</span><span class="o">::</span><span class="n">Sampler</span><span class="o">&amp;</span><span class="w"> </span><span class="n">sampler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">samplers</span><span class="p">[</span><span class="n">texture</span><span class="p">.</span><span class="n">sampler</span><span class="p">];</span>

<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;image: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">image</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">image</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">image</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">image</span><span class="p">.</span><span class="n">image</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// Textureç±»å·²ç»åœ¨å‰æ–‡å®šä¹‰è¿‡äº†</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">my_texture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Texture</span><span class="o">&gt;</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="n">image</span><span class="p">.</span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">image</span><span class="p">.</span><span class="n">height</span><span class="p">,</span><span class="w"> </span><span class="n">sampler</span><span class="p">.</span><span class="n">wrapS</span><span class="p">,</span><span class="w"> </span><span class="n">sampler</span><span class="p">.</span><span class="n">wrapT</span><span class="p">,</span><span class="w"> </span><span class="n">sampler</span><span class="p">.</span><span class="n">minFilter</span><span class="p">,</span><span class="w"> </span><span class="n">sampler</span><span class="p">.</span><span class="n">magFilter</span><span class="p">,</span><span class="w"> </span><span class="n">image</span><span class="p">.</span><span class="n">pixel_type</span><span class="p">);</span>

<span class="w">        </span><span class="n">textures</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">my_texture</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// è½½å…¥æè´¨</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">tinygltf</span><span class="o">::</span><span class="n">Material</span><span class="o">&amp;</span><span class="w"> </span><span class="n">mat</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">materials</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// è·å–æè´¨å¼•ç”¨çš„çº¹ç†çš„ç´¢å¼•</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">texture_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mat</span><span class="p">.</span><span class="n">pbrMetallicRoughness</span><span class="p">.</span><span class="n">baseColorTexture</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// è®¾ç½®æ­£ç¡®çš„alphaModeï¼Œé»˜è®¤éƒ½å½“ä½œä¸é€æ˜</span>
<span class="w">        </span><span class="n">Material</span><span class="o">::</span><span class="n">AlphaMode</span><span class="w"> </span><span class="n">alpha_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Material</span><span class="o">::</span><span class="n">OPAQUE</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mat</span><span class="p">.</span><span class="n">alphaMode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;BLEND&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// åŠé€æ˜</span>
<span class="w">            </span><span class="n">alpha_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Material</span><span class="o">::</span><span class="n">BLEND</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;alpha mode not support: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">mat</span><span class="p">.</span><span class="n">alphaMode</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;alpha mode: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">mat</span><span class="p">.</span><span class="n">alphaMode</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">alpha_mode</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// è·å–åˆšæ‰åˆ›å»ºå¥½çš„Texture</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">texture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">textures</span><span class="p">[</span><span class="n">texture_index</span><span class="p">];</span>

<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;load material: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">mat</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// Materialç±»å·²ç»åœ¨å‰æ–‡å®šä¹‰è¿‡äº†</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">my_material</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">PhongMaterial</span><span class="o">&gt;</span><span class="p">(</span><span class="n">shader_program</span><span class="p">,</span><span class="w"> </span><span class="n">texture</span><span class="p">,</span><span class="w"> </span><span class="n">light</span><span class="p">,</span><span class="w"> </span><span class="n">shadow_map</span><span class="p">,</span><span class="w"> </span><span class="n">alpha_mode</span><span class="p">);</span>
<span class="w">        </span><span class="n">materials</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">my_material</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// åŠ è½½BufferViewï¼Œè¿™é‡Œæ¯ä¸ªBufferViewæˆ‘éƒ½å•ç‹¬å»ºç«‹äº†ä¸€ä¸ªOpenGLçš„ç¼“å†²ï¼Œåº”è¯¥è¿˜æœ‰æ›´å¥½çš„åŠæ³•</span>
<span class="w">    </span><span class="c1">// BufferViewç±»çš„å®šä¹‰è§ä¸Šæ–‡</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">tinygltf</span><span class="o">::</span><span class="n">BufferView</span><span class="o">&amp;</span><span class="w"> </span><span class="n">view</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">bufferViews</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">GLTFBufferView</span><span class="o">&gt;</span><span class="p">(</span><span class="n">view</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">buffers</span><span class="p">[</span><span class="n">view</span><span class="p">.</span><span class="n">buffer</span><span class="p">]);</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;load bufferview: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">buffers</span><span class="p">[</span><span class="n">view</span><span class="p">.</span><span class="n">buffer</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, uri: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">buffers</span><span class="p">[</span><span class="n">view</span><span class="p">.</span><span class="n">buffer</span><span class="p">].</span><span class="n">uri</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, offset: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">view</span><span class="p">.</span><span class="n">byteOffset</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="n">bufferViews</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// åŠ è½½Meshï¼Œä¸Šæ–‡åˆšåˆšå®šä¹‰</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">tinygltf</span><span class="o">::</span><span class="n">Mesh</span><span class="o">&amp;</span><span class="w"> </span><span class="n">mesh</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">meshes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">my_mesh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">GLTFMesh</span><span class="o">&gt;</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">mesh</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;load mesh: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">mesh</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="n">meshes</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">my_mesh</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<h4 id="renderqueue">RenderQueue</h4>
<p>å¯¹äºæœ‰åŠé€æ˜ç‰©ä½“çš„åœºæ™¯ï¼Œæ¯”è¾ƒæ­£ç¡®çš„æ–¹å¼æ˜¯ï¼š</p>
<ol type="1">
<li>å…è®¸æ·±åº¦ç¼“å†²å†™å…¥ï¼Œç»˜åˆ¶ä¸é€æ˜ç‰©ä½“</li>
<li>ç¦æ­¢æ·±åº¦ç¼“å†²å†™å…¥ï¼Œä»è¿œåˆ°è¿‘ç»˜åˆ¶åŠé€æ˜ç‰©ä½“</li>
</ol>
<blockquote>
<p>å…¶å®è¿™æ ·æ¸²æŸ“å‡ºæ¥çš„ç»“æœè¿˜æ˜¯æœ‰å¯èƒ½ä¸æ­£ç¡®ï¼Œalphaæ··åˆçš„é¡ºåºå¯èƒ½è¿˜æ˜¯é”™çš„ï¼Œä½†æ˜¯ä¸€èˆ¬ä¹Ÿå¤Ÿçœ‹äº†ã€‚</p>
</blockquote>
<p>ä¸ºäº†å®ç°ä»è¿œåˆ°è¿‘ç»˜åˆ¶åŠé€æ˜ç‰©ä½“ï¼Œæˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªæ¸²æŸ“é˜Ÿåˆ—ï¼Œåˆ†åˆ«æ¸²æŸ“ä¸é€æ˜å’ŒåŠé€æ˜çš„ç‰©ä½“ã€‚æ¸²æŸ“åŠé€æ˜ç‰©ä½“å‰è¿˜è¦æŒ‰ç…§å¯¹åº”Nodeçš„æ·±åº¦ï¼ˆNodeè‡ªèº«åæ ‡ç³»çš„åŸç‚¹ï¼Œå¯¹åº”çš„ä¸–ç•Œåæ ‡çš„ç‚¹çš„æ·±åº¦ï¼‰é™åºæ’åºï¼Œä¾æ¬¡æ¸²æŸ“ã€‚<code>RenderQueue</code>æ˜¯ä¸ªå•ä¾‹ã€‚æ¯ä¸ªPrimitiveçš„æ¸²æŸ“éƒ½è¦å°è£…åˆ°ä¸€ä¸ª<code>RenderRequest</code>é‡Œé¢ã€‚</p>
<div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">GLTFRenderRequest</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// éƒ½æ˜¯è°ƒç”¨Primitiveçš„drawæ‰€éœ€çš„å‚æ•°</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">Camera</span><span class="o">*</span><span class="w"> </span><span class="n">cam</span><span class="p">;</span>
<span class="w">    </span><span class="n">glm</span><span class="o">::</span><span class="n">mat4</span><span class="w"> </span><span class="n">transform</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Material</span><span class="o">&gt;</span><span class="w"> </span><span class="n">material</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">GLTFPrimitive</span><span class="o">&gt;</span><span class="w"> </span><span class="n">primitive</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">.0f</span><span class="p">;</span><span class="w"> </span><span class="c1">// æ·±åº¦</span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="k">operator</span><span class="o">&lt;</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">GLTFRenderRequest</span><span class="o">&amp;</span><span class="w"> </span><span class="n">req</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">req</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">GLTFRenderQueue</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">GLTFRenderQueue</span><span class="o">*</span><span class="w"> </span><span class="n">getInstance</span><span class="p">();</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">render</span><span class="p">();</span><span class="w"> </span><span class="c1">// æ¸²æŸ“ï¼</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">push</span><span class="p">(</span><span class="n">GLTFRenderRequest</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">request</span><span class="p">);</span><span class="w"> </span><span class="c1">// å…¥é˜Ÿ</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">explicit</span><span class="w"> </span><span class="n">GLTFRenderQueue</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">default</span><span class="p">;</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="n">GLTFRenderQueue</span><span class="w"> </span><span class="o">*</span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">deque</span><span class="o">&lt;</span><span class="n">GLTFRenderRequest</span><span class="o">&gt;</span><span class="w"> </span><span class="n">opaque_queue</span><span class="p">;</span><span class="w"> </span><span class="c1">// ä¸é€æ˜ç‰©ä½“</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">deque</span><span class="o">&lt;</span><span class="n">GLTFRenderRequest</span><span class="o">&gt;</span><span class="w"> </span><span class="n">blend_queue</span><span class="p">;</span><span class="w"> </span><span class="c1">// åŠé€æ˜ç‰©ä½“</span>
<span class="p">};</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">GLTFRenderQueue</span><span class="o">*</span><span class="w"> </span><span class="nf">GLTFRenderQueue::getInstance</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">instance</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GLTFRenderQueue</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">instance</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">GLTFRenderQueue::push</span><span class="p">(</span><span class="n">GLTFRenderRequest</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// æŠŠä¸é€æ˜å’Œé€æ˜åˆ†å¼€</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">material</span><span class="o">-&gt;</span><span class="n">alpha_mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">Material</span><span class="o">::</span><span class="no">BLEND</span><span class="p">:</span>
<span class="w">        </span><span class="n">blend_queue</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span>
<span class="w">        </span><span class="n">opaque_queue</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">GLTFRenderQueue::render</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 1. å¯ç”¨æ·±åº¦å†™å…¥</span>
<span class="w">    </span><span class="n">glDepthMask</span><span class="p">(</span><span class="n">GL_TRUE</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 2. æ¸²æŸ“ä¸é€æ˜ç‰©ä½“</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">opaque_queue</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">GLTFRenderRequest</span><span class="o">&amp;</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">opaque_queue</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
<span class="w">        </span><span class="n">request</span><span class="p">.</span><span class="n">primitive</span><span class="o">-&gt;</span><span class="n">draw</span><span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="p">.</span><span class="n">cam</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="n">transform</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="n">material</span><span class="p">);</span>
<span class="w">        </span><span class="n">opaque_queue</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">opaque_queue</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// 3. ç¦ç”¨æ·±åº¦å†™å…¥</span>
<span class="w">    </span><span class="n">glDepthMask</span><span class="p">(</span><span class="n">GL_FALSE</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 4. æŒ‰ç…§æ·±åº¦ç”±è¿œåˆ°è¿‘æ’åº</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">sort</span><span class="p">(</span><span class="n">blend_queue</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">blend_queue</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
<span class="w">    </span><span class="c1">// 5. ç”±è¿œåˆ°è¿‘æ¸²æŸ“</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">blend_queue</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">GLTFRenderRequest</span><span class="o">&amp;</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blend_queue</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
<span class="w">        </span><span class="n">request</span><span class="p">.</span><span class="n">primitive</span><span class="o">-&gt;</span><span class="n">draw</span><span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="p">.</span><span class="n">cam</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="n">transform</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="n">material</span><span class="p">);</span>
<span class="w">        </span><span class="n">blend_queue</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">blend_queue</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// 6. æœ€ååˆ«å¿˜äº†æŠŠæ·±åº¦å†™å…¥å†æ‰“å¼€</span>
<span class="w">    </span><span class="n">glDepthMask</span><span class="p">(</span><span class="n">GL_TRUE</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ<code>GLTFMesh</code>çš„æ·±åº¦æ”¹æˆä¸‹é¢çš„æ ·å­ï¼Œè°ƒç”¨å®ƒçš„drawå‡½æ•°å…¶å®åªæ˜¯æŠŠRenderRequesté€è¿›é˜Ÿåˆ—é‡Œï¼Œå¹¶éçœŸçš„è¿›è¡Œç»˜åˆ¶ã€‚</p>
<div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">GLTFMesh::draw</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Camera</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cam</span><span class="p">,</span><span class="w"> </span><span class="n">glm</span><span class="o">::</span><span class="n">mat4</span><span class="o">&amp;</span><span class="w"> </span><span class="n">transform</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Material</span><span class="o">&gt;</span><span class="w"> </span><span class="n">material</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="o">*</span><span class="w"> </span><span class="n">render_queue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GLTFRenderQueue</span><span class="o">::</span><span class="n">getInstance</span><span class="p">();</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">pr</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">primitives</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// pr-&gt;draw(cam, transform, material);</span>

<span class="w">        </span><span class="c1">// è¿™é‡Œä¸èƒ½ä¸ä¹˜projectçŸ©é˜µï¼Œå¦åˆ™æ·±åº¦éƒ½æ˜¯è´Ÿçš„ï¼Œä¸”è¶Šè´Ÿè¶Šè¿œ</span>
<span class="w">        </span><span class="n">glm</span><span class="o">::</span><span class="n">vec4</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cam</span><span class="p">.</span><span class="n">project</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cam</span><span class="p">.</span><span class="n">view</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">transform</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">glm</span><span class="o">::</span><span class="n">vec4</span><span class="p">(</span><span class="mf">.0f</span><span class="p">,</span><span class="w"> </span><span class="mf">.0f</span><span class="p">,</span><span class="w"> </span><span class="mf">.0f</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">);</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">pos</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">material</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">material</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">default_material</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// æŠŠRenderRequestå…¥é˜Ÿ</span>
<span class="w">        </span><span class="n">render_queue</span><span class="o">-&gt;</span><span class="n">push</span><span class="p">(</span><span class="n">GLTFRenderRequest</span><span class="p">{</span>
<span class="w">            </span><span class="p">.</span><span class="n">cam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cam</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">transform</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transform</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">material</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">material</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">primitive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pr</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="p">,</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>æœ€åï¼Œæˆ‘ä»¬è¡¥ä¸Šåˆšæ‰æ²¡å®ç°çš„<code>GLTFScene</code>çš„<code>render</code>å‡½æ•°å’Œ<code>draw_node</code>å‡½æ•°</p>
<div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">GLTFScene::draw_node</span><span class="p">(</span><span class="n">tinygltf</span><span class="o">::</span><span class="n">Node</span><span class="o">&amp;</span><span class="w"> </span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Camera</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cam</span><span class="p">,</span><span class="w"> </span><span class="n">glm</span><span class="o">::</span><span class="n">mat4</span><span class="o">&amp;</span><span class="w"> </span><span class="n">transform</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Material</span><span class="o">&gt;</span><span class="w"> </span><span class="n">material</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">glm</span><span class="o">::</span><span class="n">mat4</span><span class="w"> </span><span class="n">matrix</span><span class="p">(</span><span class="mf">1.0f</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// gltfæ ‡å‡†è§„å®šï¼Œnodeè¦ä¹ˆæœ‰matrixï¼Œè¦ä¹ˆæœ‰TRS</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">matrix</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">matrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">glm</span><span class="o">::</span><span class="n">make_mat4</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">matrix</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">scale</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">glm</span><span class="o">::</span><span class="n">mat4</span><span class="w"> </span><span class="n">scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">glm</span><span class="o">::</span><span class="n">scale</span><span class="p">(</span><span class="n">glm</span><span class="o">::</span><span class="n">mat4</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span><span class="w"> </span><span class="n">glm</span><span class="o">::</span><span class="n">vec3</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">scale</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
<span class="w">            </span><span class="n">matrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scale</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">matrix</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">rotation</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">glm</span><span class="o">::</span><span class="n">quat</span><span class="w"> </span><span class="n">qua</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">rotation</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">rotation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">rotation</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">rotation</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="w">            </span><span class="n">glm</span><span class="o">::</span><span class="n">mat4</span><span class="w"> </span><span class="n">rotate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">glm</span><span class="o">::</span><span class="n">mat4_cast</span><span class="p">(</span><span class="n">qua</span><span class="p">);</span>
<span class="w">            </span><span class="n">matrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rotate</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">matrix</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">translation</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">glm</span><span class="o">::</span><span class="n">mat4</span><span class="w"> </span><span class="n">translate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">glm</span><span class="o">::</span><span class="n">translate</span><span class="p">(</span><span class="n">glm</span><span class="o">::</span><span class="n">mat4</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span><span class="w"> </span><span class="n">glm</span><span class="o">::</span><span class="n">vec3</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">translation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">translation</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">translation</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
<span class="w">            </span><span class="n">matrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">translate</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">matrix</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// æ³¨æ„ä¹˜æ³•é¡ºåº</span>
<span class="w">    </span><span class="c1">// matrixæŠŠæœ¬nodeå˜æ¢åˆ°çˆ¶nodeçš„åæ ‡ç³»</span>
<span class="w">    </span><span class="c1">// transformæŠŠçˆ¶nodeå˜æ¢åˆ°ä¸–ç•Œåæ ‡ç³»</span>
<span class="w">    </span><span class="c1">// äºŒè€…ç›¸ä¹˜ï¼Œå³ä¸ºæŠŠæœ¬nodeå˜æ¢åˆ°ä¸–ç•Œåæ ‡ç³»</span>
<span class="w">    </span><span class="n">glm</span><span class="o">::</span><span class="n">mat4</span><span class="w"> </span><span class="n">real_transform</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transform</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">matrix</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æœ‰äº›Nodeå¯èƒ½ä¸å«mesh</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">mesh</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">mesh_ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">meshes</span><span class="p">[</span><span class="n">node</span><span class="p">.</span><span class="n">mesh</span><span class="p">];</span>
<span class="w">        </span><span class="c1">// è°ƒç”¨meshçš„draw</span>
<span class="w">        </span><span class="n">mesh_ref</span><span class="o">-&gt;</span><span class="n">draw</span><span class="p">(</span><span class="n">cam</span><span class="p">,</span><span class="w"> </span><span class="n">real_transform</span><span class="p">,</span><span class="w"> </span><span class="n">material</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// ç»˜åˆ¶æ‰€æœ‰å­node</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">children</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">tinygltf</span><span class="o">::</span><span class="n">Node</span><span class="o">&amp;</span><span class="w"> </span><span class="n">next_node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">child</span><span class="p">];</span>
<span class="w">        </span><span class="n">draw_node</span><span class="p">(</span><span class="n">next_node</span><span class="p">,</span><span class="w"> </span><span class="n">cam</span><span class="p">,</span><span class="w"> </span><span class="n">real_transform</span><span class="p">,</span><span class="w"> </span><span class="n">material</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>è‡³æ­¤ï¼Œæˆ‘ä»¬åªéœ€åœ¨<code>Application</code>åˆå§‹åŒ–æ—¶è½½å…¥æ¨¡å‹ï¼Œåœ¨å…¶ä¸»å¾ªç¯<code>main_loop</code>å½“ä¸­çš„é€‚å½“ä½ç½®è°ƒç”¨<code>GLTFScene</code>çš„<code>render</code>å³å¯ã€‚</p>
<p>å¦‚æœè¿˜æ˜¯ä¸€å¤´é›¾æ°´ï¼Œå®Œæ•´ä»£ç è¯¦è§<a
href="https://github.com/fpg2012/QuickOpenGL">fpg2012/QuickOpenGL</a></p>
<h2 id="æ•ˆæœ">æ•ˆæœ</h2>
<p>æ¨¡å‹æ¥è‡ªSketchFabï¼Œä½œè€…peachyroyaltyï¼Œéµå¾ªCC BY-NC 4.0ã€‚</p>
<div class="sketchfab-embed-wrapper">
<iframe style="width:100%;aspect-ratio:1.0;" title="Forest House" frameborder="0" allowfullscreen mozallowfullscreen="true" webkitallowfullscreen="true" allow="autoplay; fullscreen; xr-spatial-tracking" xr-spatial-tracking execution-while-out-of-viewport execution-while-not-rendered web-share src="https://sketchfab.com/models/52429e4ef7bf4deda1309364a2cda86f/embed">
</iframe>
<p style="font-size: 13px; font-weight: normal; margin: 5px; color: #4A4A4A;">
<a href="https://sketchfab.com/3d-models/forest-house-52429e4ef7bf4deda1309364a2cda86f?utm_medium=embed&utm_campaign=share-popup&utm_content=52429e4ef7bf4deda1309364a2cda86f" target="_blank" rel="nofollow" style="font-weight: bold; color: #1CAAD9;">
Forest House </a> by
<a href="https://sketchfab.com/peachyroyalty?utm_medium=embed&utm_campaign=share-popup&utm_content=52429e4ef7bf4deda1309364a2cda86f" target="_blank" rel="nofollow" style="font-weight: bold; color: #1CAAD9;">
peachyroyalty </a> on
<a href="https://sketchfab.com?utm_medium=embed&utm_campaign=share-popup&utm_content=52429e4ef7bf4deda1309364a2cda86f" target="_blank" rel="nofollow" style="font-weight: bold; color: #1CAAD9;">Sketchfab</a>
</p>
</div>
<p>æˆ‘æ¸²æŸ“çš„ç»“æœï¼Œå¯ä»¥çœ‹åˆ°åŠé€æ˜çš„æ ‘å¶æ··åˆé¡ºåºä»ç„¶æ˜¯é”™çš„ï¼ˆå…¶å®åœ¨blenderé‡Œé¢å¦‚æœä¸ç”¨cyclesæ¸²æŸ“ï¼Œæ ‘å¶çš„æ··åˆé¡ºåºä¹Ÿæ˜¯é”™çš„ï¼‰ã€‚</p>
<figure>
<img src="attachment/ae4920e639fad546be98cfdc9e775ddf.png"
alt="æ¸²æŸ“çš„ç»“æœï¼Œå¯ä»¥çœ‹åˆ°åŠé€æ˜çš„æ ‘å¶æ··åˆé¡ºåºä»ç„¶æ˜¯é”™çš„" />
<figcaption
aria-hidden="true">æ¸²æŸ“çš„ç»“æœï¼Œå¯ä»¥çœ‹åˆ°åŠé€æ˜çš„æ ‘å¶æ··åˆé¡ºåºä»ç„¶æ˜¯é”™çš„</figcaption>
</figure>

</div>

<div class="sibling-pages">
    
    
    <div class="sibling-page sibling-page-last">
        <div class="sibling-page-title"><a href="//nth233.top/posts/2024-02-08-ä½¿ç”¨esp32-c3åˆ¶ä½œç½‘ç»œæ§åˆ¶é”®ç›˜/index.html">ä½¿ç”¨esp32-c...</a></div>
        <div class="sibling-page-date">2024-02-08</div>
    </div>
    <div class="sibling-page-arrow"><a href="//nth233.top/posts/2024-02-08-ä½¿ç”¨esp32-c3åˆ¶ä½œç½‘ç»œæ§åˆ¶é”®ç›˜/index.html">ã€‰</a></div>
    
</div>




    <div class="comment-area">
<script src="https://utteranc.es/client.js"
        repo="fpg2012/fpg2012.github.io"
        issue-term="pathname"
        label="Comment"
        theme="preferred-color-scheme"
        crossorigin="anonymous"
        async>
</script>
</div>


</div>
<script src=//nth233.top/assets/js/generate-toc.js></script>

        </main>
        <script src="//nth233.top/assets/js/search.js"></script>
        <footer>
<span>Â© nth233 2024 | <span class="theme-about">Powered by <a href="https://github.com/fpg2012/sushi">sushi</a> |  Theme <a href="https://github.com/fpg2012/sushi-theme-empty">empty</a> by <a href="https://github.com/fpg2012">nth233</a></span>
</footer>
        <div id="fullscreen-img-container" class="hidden">
        </div>
        <div id="top-button" onclick="window.scrollTo(0,0)">â–³</div>
	<script src="//nth233.top/assets/js/fullscreen-img.js"></script>
    
    </body>
</html>
