<!DOCTYPE html>

<html>
    <head>
        
        <title>Empty Space - 从8086到x64</title>
        
        <meta charset="UTF-8">
        <meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport">

        
        <meta name="description" content="相信所有学习过「计算机组成原理与汇编语言」课程的人都受过8086的折磨：少得可怜的寄存器、远古开发环境、远古命令行调试器`debug`、复古的DOS操作系统，还有一点……**实机不能运行**。如果说前面几点还勉强可以忍受，那么最后一点实在是忍无可忍。8086已经是古玩了，Intel和微软的向前兼容也有限度，这导致了现在流行的64位操作系统上根本无法直接运行为8086编写的代码。于是为了继续教8086，现在国内大量学校使用某部分功能收费的IDE进行教学，写出来的东西也只能在Dosbox里面打转。但是，脱离实机的运行环境，学得再多也难对实践有太多助益。">
        

        
        <meta name="keywords" content="折腾记录,汇编,x64">
        

        <link rel="stylesheet" href="//nth233.top/assets/style/main.css">
        <link rel="stylesheet" href="//nth233.top/assets/style/tango.css">
        <link rel="stylesheet" href="//nth233.top/assets/style/katex.min.css" integrity="sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ" crossorigin="anonymous">

        
        <script async src='//cdn.jsdelivr.net/npm/valine@1.4.18/dist/Valine.min.js'></script>
        
        
        <link rel="apple-touch-icon" sizes="180x180" href="//nth233.top/assets/favicon/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="//nth233.top/assets/favicon/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="//nth233.top/assets/favicon/favicon-16x16.png">
        <link rel="manifest" href="//nth233.top/assets/favicon/site.webmanifest">
        
    </head>
    <body>
        <header>

<div class="header-logo">
    <img class="nth233logo" src="//nth233.top/assets/img/404.png"></img>
    <a href="//nth233.top/">Empty Space</a>
</div>

<div class="header-menu">
    <a href="//nth233.top/notes/">Notes</a>
    <a href="//nth233.top/about/">About</a>
    <a href="//nth233.top/feed.xml">RSS</a>
    <!--<a href="//nth233.top/friends.html">Friends</a>-->
    <button id="theme-switch">🅣</button>
</div>

</header>

        <main>
            
<div class="post-area">
<div class="post-front-matter">
    
    <h1>从8086到x64</h1>
    
    <div class="date-bar">
        <span class="date">2021-07-01</span>
    </div>
    <div class="category-bar">
    
        <span class="category">〔dev〕</span>
    
    </div>
    <div class="tag-bar">
    
        <span class="tag">#折腾记录</span>
    
        <span class="tag">#汇编</span>
    
        <span class="tag">#x64</span>
    
    </div>
</div>
<hr class="hr-wavy">
<div class="post-content">
    <p>相信所有学习过「计算机组成原理与汇编语言」课程的人都受过8086的折磨：少得可怜的寄存器、远古开发环境、远古命令行调试器<code>debug</code>、复古的DOS操作系统，还有一点……<strong>实机不能运行</strong>。如果说前面几点还勉强可以忍受，那么最后一点实在是忍无可忍。8086已经是古玩了，Intel和微软的向前兼容也有限度，这导致了现在流行的64位操作系统上根本无法直接运行为8086编写的代码。于是为了继续教8086，现在国内大量学校使用某部分功能收费的IDE进行教学，写出来的东西也只能在Dosbox里面打转。但是，脱离实机的运行环境，学得再多也难对实践有太多助益。</p>
<p>好在从8086转到x64不困难。基础的指令基本相同，寄存器的名字也一脉相承，而且还干掉了分段和8086奇葩的20根地址线，使得编写程序更简单了（相当于以前的<code>flat</code>格式。而且转到x64还能带来生态上的改进：更先进易用的操作系统和更与时俱进的调试器，效率得以大幅提升。</p>
<blockquote>
<p>之所以给新手教8086的指令集，一般都说是因为「8086简单」。然而和它的兄弟8088相比，8086还复杂了一些，和RISC架构的几个指令集相比，8086更是一点也不简单，甚至和x64相比，8086也只是显得简陋，基础的指令集并不显得更“简单”。并且在当下，8086已经严重过时，使得学习难度变得更高。</p>
<p>过去给新手教8086，或许只是因为这个架构具有里程碑意义，而且在容易找到可以运行的实机（得益于Intel和微软的垄断地位）。现在给新手教8086，也许只是因为懒于改革而已。实际上应该新手适合学x64（有实机）或者RISC-V（简单）。</p>
</blockquote>
<h2 id="第一步寄存器和指令">第一步：寄存器和指令</h2>
<h3 id="寄存器">寄存器</h3>
<p>在基础的指令集上，实际上没有什么改变的；寄存器也只是改了个名、加了些新的。首先，在<code>ax</code>、<code>bx</code>、<code>cx</code>、<code>dx</code>、<code>si</code>、<code>di</code>这几个8086的通用寄存器前面加上<code>r</code>，就得到相应的64位寄存器，比如<code>rax</code>、<code>rdi</code>。原先的名字依然可以使用，不过得到的是这几个通用寄存器的低16位。把<code>r</code>换成<code>e</code>，就得到64位寄存器的低32位，比如<code>eax</code>，这是i386的遗产。<code>ah</code>、<code>al</code>这几个8位寄存器仍然可以使用，含义和以前相同。<code>flags</code>现在叫做<code>rflags</code>，它也是64位宽，不过高32位尚未使用，低32位和32位的<code>eflags</code>相同，低16位和之前的<code>flags</code>相同。</p>
<p>另外，x64引入了<code>r8</code>到<code>r15</code>8个新通用寄存器，都是64位宽。后面加上<code>d</code>表示取其低32位，加上<code>w</code>代表取其低16位，加上<code>b</code>代表取其低8位（在intel格式中用<code>l</code>）。注意，不存在<code>r8h</code>这个寄存器，传统的高8位寄存器<code>ah</code>、<code>bh</code>、<code>ch</code>、<code>dh</code>不能和<code>r8b</code>这些寄存器同时出现在一条指令里。</p>
<blockquote>
<p><code>d</code>代表双字（doubleword，32位），<code>w</code>代表字（word，16位），<code>b</code>代表字节（byte）。后面还会提到<code>q</code>，代表肆字（quadword，64位）。「肆字」这个叫法是我自己编的，译法参照化学中的「碳碳叁键」。</p>
</blockquote>
<p><code>ip</code>现在叫做<code>rip</code>。</p>
<p>你会发现我没有提到<code>ds</code>、<code>cs</code>等段寄存器，没错，他们被干掉了。长模式下段寄存器无用。</p>
<p>此外还有80位宽的浮点数寄存器<code>fpr0</code>到<code>fpr7</code>，他们的低64位用于MMX寄存器，更具体的内容这里不赘述，因为编写简单的程序似乎不怎么会用到，具体可以查看Intel或AMD的文档。</p>
<h3 id="指令">指令</h3>
<p>指令实际上没有什么不同。原先的指令被全数保留，即使有细微的差别，通过查文档也可以解决。</p>
<p>所有的指令后面加上<code>q</code>、<code>d</code>、<code>w</code>、<code>b</code>可以指明后面操作数的宽度。不过一般不需要手动加，汇编器会自动做。比如下面两条指令其实没有什么差别。</p>
<div class="highlight"><pre><span></span>addq rax, 100
add rax, 100
</pre></div>

<p>乘法指令和除法指令也和以前几乎一样。</p>
<div class="highlight"><pre><span></span>mul bx
mul rbx
</pre></div>

<p>第一条指令会把<code>ax</code>乘<code>bx</code>结果的高位存在<code>dx</code>中，低位存在<code>ax</code>中；类似地，第二条指令会把<code>rax</code>乘<code>rbx</code>的结果存在<code>rdx</code>:<code>rax</code>中。</p>
<p>另外还有一点值得注意，寻址的时候应该使用64位寄存器。比如</p>
<div class="highlight"><pre><span></span>mov ax, word ptr [rsp + 8]
</pre></div>

<p>把<code>rsp</code>换成<code>sp</code>则是不对的。</p>
<h2 id="第二步操作系统和汇编器">第二步：操作系统和汇编器</h2>
<p>由于笔者使用Linux，因此下面的内容只针对Linux操作系统。实际上Windows下也只是换汤不换药，改成Windows的系统调用即可。</p>
<p>汇编器我选择了GAS（GNU
Assembler），很多发行装好就自带binutils了，其中就包括了GAS。使用命令<code>as</code>就可以调用GAS。链接器自然也使用binutils的<code>ld</code>。GAS默认使用AT&amp;T的汇编格式，立即数前加<code>$</code>，寄存器名字前加<code>%</code>，源操作数在前，目标操作数在后。不过我实在难以习惯，还是使用intel的格式。</p>
<h3 id="调用约定">调用约定</h3>
<p>Linux继承了System V的调用约定（calling
conventions），<code>rdi</code>存放第一个参数，<code>rsi</code>存放第二个参数，<code>rdx</code>存放第三个参数，<code>r10</code>存放第四个参数，<code>r8</code>存放第五个参数，<code>r9</code>存放第六参数。第一个返回值存在<code>rax</code>中，第二个返回值存在<code>rdx</code>中。按照约定，被调用者保证调用后<code>rbx</code>、<code>r12</code>到<code>r15</code>、<code>rbp</code>和<code>rsp</code>
内容不变。</p>
<p>详见下图</p>
<figure>
<img src="/assets/img/post/calling.png"
alt="System V Calling Convention" />
<figcaption aria-hidden="true">System V Calling Convention</figcaption>
</figure>
<h3 id="系统调用">系统调用</h3>
<p>系统调用除了要按照上面的调用约定进行调用外，还需要往<code>rax</code>中放入系统调用号。下面的最常用的两个系统调用：</p>
<table>
<colgroup>
<col style="width: 8%" />
<col style="width: 18%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="header">
<th><code>rax</code></th>
<th>System Call</th>
<th><code>rdi</code></th>
<th><code>rsi</code></th>
<th><code>rdx</code></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>sys_read</td>
<td>unsigned int fd</td>
<td>char *buf</td>
<td>size_t count</td>
</tr>
<tr class="even">
<td>1</td>
<td>sys_write</td>
<td>unsigned int fd</td>
<td>const char *buf</td>
<td>size_t count</td>
</tr>
<tr class="odd">
<td>60</td>
<td>sys_exit</td>
<td>int error_code</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p><code>read</code>和<code>write</code>返回值都是实际读/写的字节数。<code>exit</code>结束程序，可以设定程序退出后返回的错误码，<code>0</code>表示正常。</p>
<p>准备好相关参数，就可以使用<code>syscall</code>指令直接进行系统调用。比如下面的代码，把<code>rsi</code>指向的内容输出到标准输出中。（UNIX中一切皆文件，<code>stdin</code>的文件描述符为0，<code>stdout</code>为1，<code>stderr</code>为2）</p>
<div class="highlight"><pre><span></span>lea rsi, msg # msg为要输出的字符串的标号
mov rdi, 1
mov rax, 1
mov rdx, 5 # 输出五个字符
syscall # 系统调用
</pre></div>

<p>如果<code>msg</code>的位置指向字符串<code>helloworld\0</code>，那么调用后将输出<code>hello</code>。</p>
<p>类似地，下面的代码用于终止程序</p>
<div class="highlight"><pre><span></span>mov rax, 60
mov rdi, 0
syscall
</pre></div>

<p>相当于DOS下8086的</p>
<div class="highlight"><pre><span></span>mov ax, 4c00h
int 21h
</pre></div>

<h3 id="gas代码格式">GAS代码格式</h3>
<p>MASM中里面需要用<code>xxx segment</code>和<code>xxx ends</code>来定义各种段，GAS中不需要。</p>
<p><code>.data</code>后面的内容就是数据段的内容，<code>.text</code>后的内容就是代码段的内容。程序的入口为<code>_start</code>，为了让汇编器找到<code>_start</code>，需要将其设为外部文件可见的，使用<code>.global _start</code>即可。<code>#</code>之后的内容为单行注释。</p>
<p>于是一个典型的程序框架如下：</p>
<div class="highlight"><pre><span></span><span class="na">.intel_syntax</span><span class="w"> </span><span class="no">noprefix</span><span class="w"> </span><span class="c1"># 启用intel格式</span>
<span class="na">.data</span><span class="w"></span>
<span class="c1"># 数据段中的一些定义</span>

<span class="na">.text</span><span class="w"></span>
<span class="na">.global</span><span class="w"> </span><span class="no">_start</span><span class="w"></span>

<span class="nl">_start:</span><span class="w"></span>
<span class="w">    </span><span class="c1"># 一些代码</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1"># 终止程序</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">60</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="nf">syscall</span><span class="w"></span>
<span class="nf">end</span><span class="w"></span>
<span class="c1"># end 之后的东西会被汇编器忽略</span>
</pre></div>

<p>GAS中有一些常用的宏。</p>
<table>
<thead>
<tr class="header">
<th></th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>.ascii</code></td>
<td>后跟字符串</td>
</tr>
<tr class="even">
<td><code>.asciz</code></td>
<td>后跟字符串，自动以0结尾</td>
</tr>
<tr class="odd">
<td><code>.byte</code></td>
<td>后跟一个字节</td>
</tr>
<tr class="even">
<td><code>.rept x</code>和<code>.endr</code></td>
<td>把<code>.rept</code>和<code>.endr</code>之间的内容重复<code>x</code>遍</td>
</tr>
</tbody>
</table>
<p>本文只是概述，更多内容可以参考GAS的文档。</p>
<p>至此，我们可以开始写第一个程序了。</p>
<h2 id="第三步hello-world">第三步：Hello World!</h2>
<p>这里直接给出程序。</p>
<div class="highlight"><pre><span></span><span class="na">.intel_syntax</span><span class="w"> </span><span class="no">noprefix</span><span class="w"></span>
<span class="na">.data</span><span class="w"></span>
<span class="nl">msg:</span><span class="w"> </span><span class="na">.ascii</span><span class="w"> </span><span class="s">&quot;Hello World!\n&quot;</span><span class="w"></span>
<span class="na">.equ</span><span class="w"> </span><span class="no">msg_len</span><span class="p">,</span><span class="w"> </span><span class="no">.-msg</span><span class="w"></span>

<span class="na">.text</span><span class="w"></span>
<span class="na">.global</span><span class="w"> </span><span class="no">_start</span><span class="w"></span>
<span class="nl">_start:</span><span class="w"></span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rsi</span><span class="p">,</span><span class="w"> </span><span class="no">msg</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="no">msg_len</span><span class="w"></span>
<span class="w">    </span><span class="nf">syscall</span><span class="w"></span>

<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">60</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="nf">syscall</span><span class="w"></span>
<span class="na">.end</span><span class="w"></span>
</pre></div>

<p>第四行的<code>.equ msglen, .-msg</code>定义了一个新符号<code>msglen</code>，<code>.-msg</code>代表当前地址减去<code>msg</code>的偏移量，即为字符串的长度。</p>
<p>编写完成后命名为<code>helloworld.s</code>，然后调用下面的命令进行汇编。<code>-g</code>是为了便生成调试信息，可以去掉。</p>
<div class="highlight"><pre><span></span>as -g helloworld.s -o helloworld.o
</pre></div>

<p>然后链接。</p>
<div class="highlight"><pre><span></span>ld helloworld.o -o helloworld
</pre></div>

<p>此时应该会得到一个可执行文件<code>helloworld</code>，执行之，即可获得预期的结果：终端输出了<code>Hello World!</code>。</p>
<p>只写个Helloworld略有一点乏味，下面的程序读取用户输入的数字，转成二进制输出，把<code>0</code>输出为绿色。其中使用了颜色代码<code>\033[0;32m</code>（绿色）和<code>\033[0m</code>（默认颜色）。绿色代码后的字符全部显示为绿色，默认颜色同理。</p>
<div class="highlight"><pre><span></span><span class="na">.intel_syntax</span><span class="w"> </span><span class="no">noprefix</span><span class="w"></span>
<span class="na">.data</span><span class="w"></span>
<span class="nl">input_buffer:</span><span class="w"></span>
<span class="na">.rept</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span>
<span class="w">    </span><span class="no">.byte</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span>
<span class="no">.endr</span><span class="w"></span>
<span class="nl">output_buffer:</span><span class="w"></span>
<span class="na">.rept</span><span class="w"> </span><span class="mi">100</span><span class="w"></span>
<span class="w">    </span><span class="na">.byte</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="na">.endr</span><span class="w"></span>
<span class="nl">msg1:</span><span class="w"> </span><span class="na">.asciz</span><span class="w"> </span><span class="s">&quot;input a num (hex): &quot;</span><span class="w"></span>
<span class="nl">msg2:</span><span class="w"> </span><span class="na">.asciz</span><span class="w"> </span><span class="s">&quot;binary: &quot;</span><span class="w"></span>
<span class="nl">color_start:</span><span class="w"> </span><span class="na">.asciz</span><span class="w"> </span><span class="s">&quot;\033[0;32m&quot;</span><span class="w"></span>
<span class="nl">color_reset:</span><span class="w"> </span><span class="na">.asciz</span><span class="w"> </span><span class="s">&quot;\033[0m&quot;</span><span class="w"></span>
<span class="nl">lf:</span><span class="w"> </span><span class="na">.ascii</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="w"></span>


<span class="na">.text</span><span class="w"></span>
<span class="na">.global</span><span class="w"> </span><span class="no">_start</span><span class="w"></span>

<span class="c1"># output LF</span>
<span class="nl">_newline:</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rsi</span><span class="p">,</span><span class="w"> </span><span class="no">lf</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="nf">syscall</span><span class="w"></span>
<span class="w">    </span><span class="nf">ret</span><span class="w"></span>
<span class="w">    </span>
<span class="c1"># rdi - string to insert</span>
<span class="c1"># rsi - buffer begin</span>
<span class="c1"># rdx - pos</span>
<span class="nl">_insert_into_buffer:</span><span class="w"></span>
<span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="no">rax</span><span class="p">,</span><span class="w"> </span><span class="no">rax</span><span class="w"></span>
<span class="nl">insert_into_buffer_loop:</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">al</span><span class="p">,</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="nf">inc</span><span class="w"> </span><span class="no">rdi</span><span class="w"></span>
<span class="w">    </span><span class="nf">cmp</span><span class="w"> </span><span class="no">al</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="nf">jz</span><span class="w"> </span><span class="no">insert_into_buffer_loop_end</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsi</span><span class="err">+</span><span class="no">rdx</span><span class="p">],</span><span class="w"> </span><span class="no">al</span><span class="w"></span>
<span class="w">    </span><span class="nf">inc</span><span class="w"> </span><span class="no">rdx</span><span class="w"></span>
<span class="w">    </span><span class="nf">jmp</span><span class="w"> </span><span class="no">insert_into_buffer_loop</span><span class="w"></span>
<span class="nl">insert_into_buffer_loop_end:</span><span class="w"></span>
<span class="w">    </span><span class="nf">ret</span><span class="w"></span>
<span class="w">    </span>
<span class="c1"># output rbx in binary</span>
<span class="nl">_output_bin:</span><span class="w"></span>
<span class="w">    </span><span class="nf">push</span><span class="w"> </span><span class="no">r12</span><span class="w"></span>
<span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="no">rcx</span><span class="w"></span>
<span class="nl">output_bin_loop:</span><span class="w"></span>

<span class="w">    </span><span class="nf">inc</span><span class="w"> </span><span class="no">rcx</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">r10</span><span class="p">,</span><span class="w"> </span><span class="no">rbx</span><span class="w"></span>
<span class="w">    </span><span class="nf">and</span><span class="w"> </span><span class="no">r10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">r10B</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">0</span><span class="err">&#39;</span><span class="w"></span>
<span class="w">    </span><span class="nf">push</span><span class="w"> </span><span class="no">r10</span><span class="w"></span>
<span class="w">    </span><span class="nf">sar</span><span class="w"> </span><span class="no">rbx</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="nf">cmp</span><span class="w"> </span><span class="no">rbx</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="nf">jnz</span><span class="w"> </span><span class="no">output_bin_loop</span><span class="w"></span>

<span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="no">rdx</span><span class="w"></span>
<span class="nl">output_bin_loop2:</span><span class="w"></span>
<span class="w">    </span><span class="nf">pop</span><span class="w"> </span><span class="no">rax</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdx</span><span class="err">+</span><span class="no">output_buffer</span><span class="p">],</span><span class="w"> </span><span class="no">al</span><span class="w"></span>
<span class="w">    </span><span class="nf">cmp</span><span class="w"> </span><span class="no">al</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">1</span><span class="err">&#39;</span><span class="w"></span>
<span class="w">    </span><span class="nf">jz</span><span class="w"> </span><span class="no">output_bin_loop2_even</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">r12b</span><span class="p">,</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdx</span><span class="err">+</span><span class="no">output_buffer</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rdi</span><span class="p">,</span><span class="w"> </span><span class="no">color_start</span><span class="w"></span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rsi</span><span class="p">,</span><span class="w"> </span><span class="no">output_buffer</span><span class="w"></span>
<span class="w">    </span><span class="nf">call</span><span class="w"> </span><span class="no">_insert_into_buffer</span><span class="w"></span>

<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdx</span><span class="err">+</span><span class="no">output_buffer</span><span class="p">],</span><span class="w"> </span><span class="no">r12b</span><span class="w"></span>
<span class="w">    </span><span class="nf">inc</span><span class="w"> </span><span class="no">rdx</span><span class="w"></span>

<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rdi</span><span class="p">,</span><span class="w"> </span><span class="no">color_reset</span><span class="w"></span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rsi</span><span class="p">,</span><span class="w"> </span><span class="no">output_buffer</span><span class="w"></span>
<span class="w">    </span><span class="nf">call</span><span class="w"> </span><span class="no">_insert_into_buffer</span><span class="w"></span>
<span class="w">    </span><span class="nf">jmp</span><span class="w"> </span><span class="no">output_bin_loop2_odd</span><span class="w"></span>
<span class="nl">output_bin_loop2_even:</span><span class="w"></span>
<span class="w">    </span><span class="nf">inc</span><span class="w"> </span><span class="no">rdx</span><span class="w"></span>
<span class="nl">output_bin_loop2_odd:</span><span class="w"></span>
<span class="w">    </span><span class="nf">loop</span><span class="w"> </span><span class="no">output_bin_loop2</span><span class="w"></span>
<span class="w">    </span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rsi</span><span class="p">,</span><span class="w"> </span><span class="no">output_buffer</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="nf">syscall</span><span class="w"></span>

<span class="w">    </span><span class="nf">pop</span><span class="w"> </span><span class="no">r12</span><span class="w"></span>
<span class="w">    </span><span class="nf">ret</span><span class="w"></span>

<span class="c1"># read line into input buffer</span>
<span class="nl">_read_into_buffer:</span><span class="w"></span>
<span class="w">    </span><span class="nf">push</span><span class="w"> </span><span class="no">r12</span><span class="w"></span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rsi</span><span class="p">,</span><span class="w"> </span><span class="no">input_buffer</span><span class="w"></span>
<span class="nl">read_into_buffer_loop:</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="nf">syscall</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">r12b</span><span class="p">,</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsi</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="nf">inc</span><span class="w"> </span><span class="no">rsi</span><span class="w"></span>
<span class="w">    </span><span class="nf">cmp</span><span class="w"> </span><span class="no">r12b</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;\</span><span class="no">n</span><span class="err">&#39;</span><span class="w"></span>
<span class="w">    </span><span class="nf">jnz</span><span class="w"> </span><span class="no">read_into_buffer_loop</span><span class="w"></span>
<span class="w">    </span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsi</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rax</span><span class="p">,</span><span class="w"> </span><span class="no">rsi</span><span class="w"></span>
<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rax</span><span class="p">,</span><span class="w"> </span><span class="no">offset</span><span class="w"> </span><span class="no">input_buffer</span><span class="w"></span>
<span class="w">    </span><span class="nf">dec</span><span class="w"> </span><span class="no">rax</span><span class="w"></span>
<span class="w">    </span><span class="nf">pop</span><span class="w"> </span><span class="no">r12</span><span class="w"></span>
<span class="w">    </span><span class="nf">ret</span><span class="w"></span>

<span class="c1"># parse input buffer, write result into rax</span>
<span class="c1"># rdi - start of string</span>
<span class="c1"># rdx - length</span>
<span class="nl">_parse_input:</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="no">rdx</span><span class="w"></span>
<span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="no">rbx</span><span class="p">,</span><span class="w"> </span><span class="no">rbx</span><span class="w"></span>
<span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="no">rax</span><span class="p">,</span><span class="w"> </span><span class="no">rax</span><span class="w"></span>
<span class="nl">parse_input_loop:</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">bl</span><span class="p">,</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="nf">cmp</span><span class="w"> </span><span class="no">bl</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="no">A</span><span class="err">&#39;</span><span class="w"></span>
<span class="w">    </span><span class="nf">jge</span><span class="w"> </span><span class="no">parse_input_le</span><span class="w"></span>
<span class="w">    </span><span class="c1"># less then 10</span>
<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">bl</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">0</span><span class="err">&#39;</span><span class="w"></span>
<span class="w">    </span><span class="nf">jmp</span><span class="w"> </span><span class="no">parse_input_le_end</span><span class="w"></span>
<span class="nl">parse_input_le:</span><span class="w"></span>
<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">bl</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="no">A</span><span class="err">&#39;</span><span class="w"></span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">bl</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
<span class="nl">parse_input_le_end:</span><span class="w"></span>
<span class="w">    </span><span class="nf">shl</span><span class="w"> </span><span class="no">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rax</span><span class="p">,</span><span class="w"> </span><span class="no">rbx</span><span class="w"></span>
<span class="w">    </span><span class="nf">inc</span><span class="w"> </span><span class="no">rdi</span><span class="w"></span>
<span class="w">    </span><span class="nf">loop</span><span class="w"> </span><span class="no">parse_input_loop</span><span class="w"></span>
<span class="w">    </span><span class="nf">ret</span><span class="w"></span>

<span class="c1"># calc length, and print the string in rsi</span>
<span class="nl">_myputs:</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">r10</span><span class="p">,</span><span class="w"> </span><span class="no">rsi</span><span class="w"></span>
<span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="no">rdx</span><span class="w"></span>
<span class="nl">myputs_loop:</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">bl</span><span class="p">,</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsi</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="nf">cmp</span><span class="w"> </span><span class="no">bl</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="nf">jz</span><span class="w"> </span><span class="no">myputs_loop_end</span><span class="w"></span>
<span class="w">    </span><span class="nf">inc</span><span class="w"> </span><span class="no">rdx</span><span class="w"></span>
<span class="w">    </span><span class="nf">inc</span><span class="w"> </span><span class="no">rsi</span><span class="w"></span>
<span class="w">    </span><span class="nf">jmp</span><span class="w"> </span><span class="no">myputs_loop</span><span class="w"></span>
<span class="nl">myputs_loop_end:</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rsi</span><span class="p">,</span><span class="w"> </span><span class="no">r10</span><span class="w"></span>
<span class="w">    </span><span class="nf">syscall</span><span class="w"></span>
<span class="w">    </span><span class="nf">ret</span><span class="w"></span>
<span class="w">    </span>
<span class="nl">_start:</span><span class="w"></span>
<span class="nl">read_input:</span><span class="w"></span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rsi</span><span class="p">,</span><span class="w"> </span><span class="no">msg1</span><span class="w"></span>
<span class="w">    </span><span class="nf">call</span><span class="w"> </span><span class="no">_myputs</span><span class="w"></span>
<span class="w">    </span><span class="nf">call</span><span class="w"> </span><span class="no">_read_into_buffer</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="no">rax</span><span class="w"></span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rdi</span><span class="p">,</span><span class="w"> </span><span class="no">input_buffer</span><span class="w"></span>
<span class="w">    </span><span class="nf">call</span><span class="w"> </span><span class="no">_parse_input</span><span class="w"></span>
<span class="w">    </span><span class="nf">push</span><span class="w"> </span><span class="no">rax</span><span class="w"></span>
<span class="w">    </span>
<span class="nl">output_in_bin:</span><span class="w"></span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rsi</span><span class="p">,</span><span class="w"> </span><span class="no">msg2</span><span class="w"></span>
<span class="w">    </span><span class="nf">call</span><span class="w"> </span><span class="no">_myputs</span><span class="w"></span>
<span class="w">    </span><span class="nf">pop</span><span class="w"> </span><span class="no">rbx</span><span class="w"></span>
<span class="w">    </span><span class="nf">call</span><span class="w"> </span><span class="no">_output_bin</span><span class="w"></span>
<span class="w">    </span><span class="nf">call</span><span class="w"> </span><span class="no">_newline</span><span class="w"></span>

<span class="w">    </span><span class="c1"># exit</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">60</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="nf">syscall</span><span class="w"></span>
<span class="na">.end</span><span class="w"></span>
</pre></div>

<p>应有以下运行结果</p>
<figure>
<img src="/assets/img/post/x64result.png" alt="x64result" />
<figcaption aria-hidden="true">x64result</figcaption>
</figure>
<h2 id="第四步用gdb调试">第四步：用<code>gdb</code>调试</h2>
<p>GDB（GNU
Debugger）对应MASM的debug，由于提供了TUI界面，要比DOS下的debug好用不知道多少倍。</p>
<div class="highlight"><pre><span></span>gdb -tui xxx
</pre></div>

<p>如是即可使用gdb的TUI界面。具体用法已经超出了本文的范畴，网上资料也不少，暂时先不填坑。这里就放一张图。</p>
<figure>
<img src="/assets/img/post/gdbtui.png" alt="gdb" />
<figcaption aria-hidden="true">gdb</figcaption>
</figure>
<h2 id="参考">参考</h2>
<ol type="1">
<li><a
href="https://software.intel.com/content/www/us/en/develop/articles/introduction-to-x64-assembly.html">x64介绍</a></li>
<li><a href="https://gitlab.com/x86-psABIs/x86-64-ABI">System V
ABI</a></li>
<li><a
href="https://docs.microsoft.com/en-us/cpp/build/x64-calling-convention?view=msvc-160">微软的调用约定</a></li>
<li><a
href="http://web.mit.edu/gnu/doc/html/as_7.html">GAS的文档</a></li>
<li><a
href="https://github.com/torvalds/linux/blob/master/arch/x86/entry/syscalls/syscall_64.tbl">Linux系统调用号表</a></li>
<li><a
href="http://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/">一份整理好的Linux系统调用表</a></li>
<li><a
href="www.intel.com/content/www/us/en/processors/architectures-software-developer-manuals.html">Intel的文档</a></li>
<li><a
href="https://en.wikibooks.org/wiki/X86_Assembly">关于x86汇编的Wikibook</a>，建议阅读</li>
</ol>

</div>

<div class="sibling-pages">
    
    <div class="sibling-page-arrow"><a href="//nth233.top/posts/2021-10-01-抄几首戴望舒的诗.html">〈</a></div>
    <div class="sibling-page sibling-page-next">
        <div class="sibling-page-title"><a href="//nth233.top/posts/2021-10-01-抄几首戴望舒的诗.html">抄几首戴望舒的诗...</a></div>
        <div class="sibling-page-date">2021-10-20</div>
    </div>
    
    
    <div class="sibling-page sibling-page-last">
        <div class="sibling-page-title"><a href="//nth233.top/posts/2021-04-29-《后来的事》.html">《后来的事》...</a></div>
        <div class="sibling-page-date">2021-04-29</div>
    </div>
    <div class="sibling-page-arrow"><a href="//nth233.top/posts/2021-04-29-《后来的事》.html">〉</a></div>
    
</div>


<div class="comment-area">
    <div defer id="vcomments"></div>
</div>

</div>

        </main>
        <footer>
<span>© nth233 2022 | <span class="theme-about">Powered by <a href="https://github.com/fpg2012/sushi">sushi</a> |  Theme <a href="https://github.com/fpg2012/sushi-theme-empty">empty</a> by <a href="https://github.com/fpg2012">nth233</a></span>
</footer>
        <div id="fullscreen-img-container" class="hidden">
        </div>
        <div id="top-button" onclick="window.scrollTo(0,0)">↥</div>
	<script src="//nth233.top/assets/js/fullscreen-img.js"></script>
    <script>
        function setCookie(cname,cvalue,exdays,path) {
            var d = new Date();
            d.setTime(d.getTime()+(exdays*24*60*60*1000));
            var expires = "expires="+d.toGMTString();
            document.cookie = cname+"="+cvalue+"; "+expires+"; "+"path="+path;
        }
        function getCookie(cname){
            var name = cname + "=";
                var ca = document.cookie.split(';');
                for(var i=0; i<ca.length; i++) {
                    var c = ca[i].trim();
                    if (c.indexOf(name)==0) { return c.substring(name.length,c.length); }
                }
            return "";
        }

        var theme_switch = document.getElementById("theme-switch");
        var doc = document.documentElement;
        const themeMedia = window.matchMedia("(prefers-color-scheme: light)");
        var theme = "light";
        if (themeMedia.matches) {
            theme = "light";
        } else {
            theme = "dark";
        }
        if (getCookie("theme") != "") {
            theme = getCookie("theme");
        }
        var update_theme = function(to_theme) {
            if (theme == "light") {
                doc.removeAttribute("class");
                setCookie("theme", "light", 30, "/");
            } else {
                doc.setAttribute("class", "dark-theme")
                setCookie("theme", "dark", 30, "/");
            }
        }
        update_theme(theme);
        theme_switch.onclick = function() {
            if (theme == "light") {
                theme = "dark";
                update_theme("dark");
            } else {
                theme = "light";
                update_theme("light");
            }
        };
        themeMedia.addListener(e => {
            if (e.matches) {
                theme = "light";
                update_theme("light");
            } else {
                theme = "dark";
                update_theme("dark");
            }
        });
    </script>
    
    <script>
        window.addEventListener('load', (event) => {
            new Valine({
                el: '#vcomments',
                appId: 'z2BI9uqhDzhyed4haUSq5K98-gzGzoHsz',
                appKey: '4R2vpq8Wy392JAroRiaL7MJY'
            });
        });
    </script>
    
    </body>
</html>
